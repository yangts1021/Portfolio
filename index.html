<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資組合與交易紀錄追蹤</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        .tab-inactive {
            color: #6b7280;
        }
        .tab-inactive:hover {
            color: #374151;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Custom Broker Styles */
        option.broker-cathay { background-color: #16a34a; color: white; }
        option.broker-fubon { background-color: #60a5fa; color: white; }
        option.broker-yuanta { background-color: #1e40af; color: white; }
        option.broker-gray { background-color: #e5e7eb; color: #1f2937; }

        /* Custom Action Styles */
        option.action-buy { background-color: #dc2626; color: white; }
        option.action-sell { background-color: #16a34a; color: white; }

        /* Tooltip style */
        [title] { cursor: help; }
        
        /* JSON Debug Area */
        .json-debug {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #334155;
            border: 1px solid #cbd5e1;
        }

        /* Bank Input Styles */
        .bank-input {
            border: 1px solid transparent;
            background: transparent;
            width: 100%;
            text-align: right;
            padding: 4px;
            border-radius: 4px;
            font-family: monospace;
            transition: all 0.2s;
        }
        .bank-input:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
        }
        .bank-input:focus {
            background: #fff;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 flex-none z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-tight">MyPortfolio</span>
                </div>
                <div class="flex space-x-4 md:space-x-8 items-center overflow-x-auto">
                    <button onclick="switchTab('transactions')" id="tab-btn-transactions" class="tab-active px-2 md:px-3 py-5 text-sm font-medium transition-colors duration-150 whitespace-nowrap">
                        <i class="fa-solid fa-pen-to-square mr-2"></i>交易紀錄
                    </button>
                    <button onclick="switchTab('overview')" id="tab-btn-overview" class="tab-inactive px-2 md:px-3 py-5 text-sm font-medium transition-colors duration-150 whitespace-nowrap">
                        <i class="fa-solid fa-gauge-high mr-2"></i>資產總覽
                    </button>
                    <button onclick="switchTab('bank')" id="tab-btn-bank" class="tab-inactive px-2 md:px-3 py-5 text-sm font-medium transition-colors duration-150 whitespace-nowrap">
                        <i class="fa-solid fa-building-columns mr-2"></i>銀行系統餘額
                    </button>
                    <button onclick="switchTab('pledge')" id="tab-btn-pledge" class="tab-inactive px-2 md:px-3 py-5 text-sm font-medium transition-colors duration-150 whitespace-nowrap">
                        <i class="fa-solid fa-hand-holding-dollar mr-2"></i>股票質押
                    </button>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4 ml-auto">
                     <button onclick="openDataSyncModal()" class="text-blue-500 hover:text-blue-700 text-sm flex items-center bg-blue-50 px-3 py-2 rounded-lg transition-colors" title="連結 Google Sheet">
                        <i class="fa-brands fa-google mr-1"></i> <span class="hidden sm:inline ml-1">讀取資料</span>
                    </button>
                    <button onclick="confirmClearAllData()" class="text-red-500 hover:text-red-700 text-sm px-2" title="清除所有資料">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6">
        <div class="max-w-7xl mx-auto space-y-6">

            <!-- Tab 1: Transactions -->
            <div id="view-transactions" class="block animate-fade-in">
                <!-- ... existing transaction content ... -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Input Form -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 sticky top-6">
                            <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                                <i class="fa-solid fa-plus-circle text-blue-500 mr-2"></i> 新增交易
                            </h2>
                            <form id="transactionForm" onsubmit="addTransaction(event)" class="space-y-4">
                                <!-- Date & Action -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">日期</label>
                                        <input type="date" id="t-date" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">動作</label>
                                        <select id="t-action" required onchange="updateActionStyle(this)" class="w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                            <option value="BUY" class="bg-red-600 text-white action-buy">買入 (Buy)</option>
                                            <option value="SELL" class="bg-green-600 text-white action-sell">賣出 (Sell)</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Symbol & Broker -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">代碼 (Symbol)</label>
                                        <input type="text" id="t-symbol" placeholder="例如: 2330, AAPL" required class="uppercase w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">券商</label>
                                        <select id="t-broker" onchange="updateBrokerStyle(this)" class="w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                            <option value="國泰證券" class="bg-green-600 text-white broker-cathay">國泰證券</option>
                                            <option value="富邦證券" class="bg-blue-400 text-white broker-fubon">富邦證券</option>
                                            <option value="元大證券" class="bg-blue-800 text-white broker-yuanta">元大證券</option>
                                            <option value="台北富邦" class="bg-gray-200 text-gray-800 broker-gray">台北富邦</option>
                                            <option value="Firstrade" class="bg-gray-200 text-gray-800 broker-gray">Firstrade</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Qty & Price -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">股數</label>
                                        <input type="number" id="t-qty" step="0.0001" min="0.0001" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">成交單價</label>
                                        <input type="number" id="t-price" step="0.0001" min="0" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                </div>
                                <!-- Currency -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">幣別</label>
                                    <select id="t-currency" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="TWD">TWD (新台幣)</option>
                                        <option value="USD">USD (美金)</option>
                                        <option value="HKD">HKD (港幣)</option>
                                        <option value="JPY">JPY (日圓)</option>
                                    </select>
                                </div>
                                <!-- Submit -->
                                <button type="submit" id="btn-add-submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all flex justify-center items-center">
                                    <span>新增紀錄</span>
                                    <i id="icon-upload-loading" class="fa-solid fa-circle-notch fa-spin ml-2 hidden"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- History List -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700">交易歷史明細</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full" id="tx-count">0 筆</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto flex-1">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">日期</th>
                                            <th scope="col" class="px-6 py-3">代碼</th>
                                            <th scope="col" class="px-6 py-3">動作</th>
                                            <th scope="col" class="px-6 py-3 text-right">股數</th>
                                            <th scope="col" class="px-6 py-3 text-right">單價</th>
                                            <th scope="col" class="px-6 py-3 text-right">總額</th>
                                            <th scope="col" class="px-6 py-3 text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-list">
                                        <!-- JS will populate this -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="empty-state-tx" class="hidden p-10 text-center text-gray-400">
                                <i class="fa-solid fa-receipt text-4xl mb-3"></i>
                                <p>目前沒有交易紀錄</p>
                                <button onclick="openDataSyncModal()" class="mt-4 text-blue-500 underline text-sm">從 Google Sheet 讀取資料</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Asset Overview -->
            <div id="view-overview" class="hidden animate-fade-in">
                
                <!-- Manual Input Section (Merged Exchange Rate) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 mt-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-sm">
                        <!-- Header with Toggle -->
                        <div class="flex justify-between items-center mb-3">
                            <div class="font-bold text-gray-700 flex items-center">
                                <i class="fa-solid fa-piggy-bank mr-2 text-yellow-500"></i> 其他類現金 & 匯率
                            </div>
                            <div class="flex bg-gray-100 rounded-lg p-0.5">
                                <button onclick="setRateMode('manual')" id="mode-btn-manual" class="px-2 py-0.5 text-xs font-medium rounded-md transition-all">手動</button>
                                <button onclick="setRateMode('auto')" id="mode-btn-auto" class="px-2 py-0.5 text-xs font-medium rounded-md transition-all">自動</button>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                             <!-- Exchange Rate Row -->
                            <div class="flex items-center justify-between bg-blue-50 p-2 rounded-lg border border-blue-100">
                                <label class="text-blue-600 font-medium">USD 匯率</label>
                                <div class="flex items-center gap-2">
                                     <div id="auto-rate-controls" class="hidden">
                                        <button onclick="fetchRealTimeRate()" class="text-blue-400 hover:text-blue-600 text-xs mr-1" title="立即更新">
                                            <i id="icon-rate-refresh" class="fa-solid fa-rotate-right"></i>
                                        </button>
                                     </div>
                                     <input type="number" id="rate-usd" value="32.5" step="0.01" onchange="updateExchangeRate('USD', this.value)" class="w-20 bg-white border border-blue-200 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 p-1 text-right font-mono font-bold">
                                </div>
                            </div>
                             <!-- Last Updated Text -->
                             <div class="flex justify-end text-[10px] text-gray-400 -mt-2 mb-1" id="rate-last-updated"></div>

                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">TWD 總額</label>
                                <input type="text" id="cash-twd" value="0" readonly class="w-32 bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded focus:ring-yellow-500 focus:border-yellow-500 p-1 text-right font-mono font-bold cursor-not-allowed">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">USD 總額</label>
                                <input type="text" id="cash-usd" value="0" readonly class="w-32 bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded focus:ring-yellow-500 focus:border-yellow-500 p-1 text-right font-mono font-bold cursor-not-allowed">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-sm">
                        <div class="font-bold text-gray-700 flex items-center mb-3">
                            <i class="fa-solid fa-money-check-dollar mr-2 text-red-500"></i> 負債 (TWD)
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">房貸 (台北富邦)</label>
                                <input type="text" id="liab-mortgage" value="0" readonly class="w-32 bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded focus:ring-red-500 focus:border-red-500 p-1 text-right font-mono font-bold cursor-not-allowed">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">信貸 (中國信託)</label>
                                <input type="text" id="liab-loan" value="0" readonly class="w-32 bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded focus:ring-red-500 focus:border-red-500 p-1 text-right font-mono font-bold cursor-not-allowed">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">股票質押 (自動計算)</label>
                                <input type="text" id="liab-pledge" value="0" readonly class="w-32 bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded focus:ring-red-500 focus:border-red-500 p-1 text-right font-mono font-bold cursor-not-allowed">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Removed Confirm Button (Auto calculated now) -->

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">證券市值</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-stock-value">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <!-- Added title attribute for tooltip -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center" title="計算公式：Σ(現有庫存股數 × 平均成本)。&#10;注意：賣出股票後，該部位成本會從此處移除，轉為已實現損益與現金。">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總投入成本 (證券) <i class="fa-regular fa-circle-question text-gray-400 ml-1"></i></div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-stock-cost">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">其他類現金</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-cash-value">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">證券未實現損益</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="total-unrealized-pnl">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">證券已實現總損益</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="total-realized-pnl">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center border-l-4 border-l-blue-400">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總損益 (已實現+未實現)</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="total-combined-pnl">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                     <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總資產 (股票+現金)</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-total-assets">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center border-l-4 border-l-red-400">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總負債</div>
                        <div class="text-2xl lg:text-3xl font-bold text-red-600" id="dash-liabilities">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-xl shadow-md text-center text-white">
                        <div class="text-blue-100 text-sm font-medium uppercase tracking-wider mb-2">淨資產總額 (資產 - 負債)</div>
                        <div class="text-4xl lg:text-5xl font-bold" id="dash-net-worth">--</div>
                        <div class="text-blue-200 text-sm mt-2">TWD</div>
                    </div>
                </div>
                
                <!-- Beta & Allocation Chart Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 w-full text-left">資產配置 (圓餅圖)</h3>
                        <div class="w-full h-64 flex justify-center">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-sm font-bold text-gray-700">曝險分析 & Beta</h3>
                            <div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">Beta = (權重 × 個股Beta) 加總</div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                                <div class="text-xs text-blue-500 font-medium">原型</div>
                                <div class="text-lg font-bold text-gray-800" id="stat-proto-val">0%</div>
                                <div class="text-xs text-gray-400" id="stat-proto-amt">$0</div>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                                <div class="text-xs text-purple-500 font-medium">槓桿</div>
                                <div class="text-lg font-bold text-gray-800" id="stat-lev-val">0%</div>
                                <div class="text-xs text-gray-400" id="stat-lev-amt">$0</div>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                                <div class="text-xs text-green-500 font-medium">類現金</div>
                                <div class="text-lg font-bold text-gray-800" id="stat-cash-val">0%</div>
                                <div class="text-xs text-gray-400" id="stat-cash-amt">$0</div>
                            </div>
                            <div class="p-3 bg-gray-800 rounded-lg border border-gray-700 shadow-md">
                                <div class="text-xs text-gray-300 font-medium">投資組合 Beta</div>
                                <div class="text-2xl font-bold text-white mt-1" id="stat-beta">0.00</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><i class="fa-solid fa-circle-info mr-1"></i> <strong>自動分類規則 (由 GAS 資料決定 Beta)：</strong></p>
                            <p class="ml-4">Beta &lt; 0.5 &rarr; <span class="text-green-600 font-bold">類現金</span></p>
                            <p class="ml-4">0.5 &le; Beta &le; 1.4 &rarr; <span class="text-blue-600 font-bold">原型</span></p>
                            <p class="ml-4">Beta &gt; 1.4 &rarr; <span class="text-purple-600 font-bold">槓桿</span></p>
                        </div>
                    </div>
                </div>

                <!-- Holdings Table Moved Here -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-6">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">持倉狀況 & 損益試算</h3>
                        <div class="flex items-center gap-2">
                             <!-- UPDATED: Refresh Button and Settings in one place -->
                             <button onclick="fetchDataFromGAS()" class="text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md transition-colors flex items-center shadow-sm">
                                <i class="fa-solid fa-rotate mr-1"></i> 更新資料
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">類別</th>
                                    <th class="px-4 py-3">代碼/幣別</th>
                                    <th class="px-4 py-3 text-right">庫存股數</th>
                                    <th class="px-4 py-3 text-right bg-yellow-50 border-l border-yellow-100 w-32">即時價格</th>
                                    <th class="px-4 py-3 text-right">倉位市值 (原幣)</th>
                                    <th class="px-4 py-3 text-right">平均成本 (原幣)</th>
                                    <th class="px-4 py-3 text-right">未實現損益 (TWD)</th>
                                    <th class="px-4 py-3 text-right">報酬率 %</th>
                                    <th class="px-4 py-3 text-right">占比 (TWD)</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-list"></tbody>
                        </table>
                    </div>
                     <div id="empty-state-pf" class="hidden p-10 text-center text-gray-400">
                        <i class="fa-solid fa-chart-pie text-4xl mb-3"></i>
                        <p>尚無持倉資料</p>
                    </div>
                </div>

            </div>

            <!-- Tab 3: Bank System Balance -->
            <div id="view-bank" class="hidden animate-fade-in">
                <!-- NEW: Top Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">銀行總餘額 (USD)</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="bank-total-usd">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">銀行總餘額 (TWD)</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="bank-total-twd">--</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">
                            <i class="fa-solid fa-building-columns text-blue-500 mr-2"></i>銀行系統餘額
                        </h3>
                         <div class="flex items-center gap-2">
                             <span class="text-xs text-gray-400">修改數值後會自動同步至 Google Sheet</span>
                             <button onclick="fetchDataFromGAS()" class="text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md transition-colors flex items-center shadow-sm">
                                <i class="fa-solid fa-rotate mr-1"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 w-1/4">銀行</th>
                                    <th class="px-6 py-3 text-right w-1/4">USD</th>
                                    <th class="px-6 py-3 text-right w-1/4">TWD</th>
                                    <th class="px-6 py-3 text-right w-1/4">貸款 (TWD)</th>
                                </tr>
                            </thead>
                            <tbody id="bank-list">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                     <div id="empty-state-bank" class="hidden p-10 text-center text-gray-400">
                        <i class="fa-solid fa-piggy-bank text-4xl mb-3"></i>
                        <p>尚無銀行資料，請先從 Google Sheet 讀取</p>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Stock Pledge (NEW) -->
            <div id="view-pledge" class="hidden animate-fade-in">
                <!-- Pledge Top Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總借款金額</div>
                        <div class="text-2xl lg:text-3xl font-bold text-red-600" id="pledge-total-loan">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">整戶維持率</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="pledge-overall-ratio">--</div>
                        <div class="text-xs text-gray-400 mt-1">安全 > 166%</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Pledge Input -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 sticky top-6">
                            <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                                <i class="fa-solid fa-hand-holding-dollar text-blue-500 mr-2"></i> 新增質借紀錄
                            </h2>
                            <form id="pledgeForm" onsubmit="addPledgeTransaction(event)" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">匯撥日期</label>
                                        <input type="date" id="p-transfer-date" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">匯入券商</label>
                                        <select id="p-broker" class="w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                            <option value="元大證金">元大證金</option>
                                            <option value="群益證券">群益證券</option>
                                            <option value="富邦證券">富邦證券</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">匯撥標的</label>
                                        <input type="text" id="p-symbol" placeholder="2330" required onchange="calculatePledgeCollateral()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">匯撥股數</label>
                                        <input type="number" id="p-qty" required onchange="calculatePledgeCollateral()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">擔保價值 (自動計算)</label>
                                    <input type="text" id="p-collateral" readonly class="w-full bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded-lg block p-2.5 font-mono font-bold">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">借款日期</label>
                                        <input type="date" id="p-loan-date" required onchange="calculateRepaymentDate()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">借款金額</label>
                                        <input type="number" id="p-loan-amount" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">質借利率 (%)</label>
                                        <input type="number" id="p-rate" step="0.01" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">還款日期</label>
                                        <input type="date" id="p-repay-date" readonly class="w-full bg-gray-100 border border-gray-300 text-gray-500 text-sm rounded-lg block p-2.5">
                                    </div>
                                </div>
                                <button type="submit" id="btn-pledge-submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all flex justify-center items-center">
                                    <span>新增質押紀錄</span>
                                    <i id="icon-pledge-loading" class="fa-solid fa-circle-notch fa-spin ml-2 hidden"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Pledge List -->
                    <div class="lg:col-span-2">
                         <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700">質押紀錄明細</h3>
                            </div>
                            <div class="overflow-x-auto flex-1">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">匯撥日</th>
                                            <th scope="col" class="px-4 py-3">標的</th>
                                            <th scope="col" class="px-4 py-3 text-right">股數</th>
                                            <th scope="col" class="px-4 py-3 text-right">擔保價值</th>
                                            <th scope="col" class="px-4 py-3">借款日</th>
                                            <th scope="col" class="px-4 py-3 text-right">借款金額</th>
                                            <th scope="col" class="px-4 py-3 text-right">利率</th>
                                            <th scope="col" class="px-4 py-3">還款日</th>
                                            <th scope="col" class="px-4 py-3 text-right">利息</th>
                                            <th scope="col" class="px-4 py-3 text-right">維持率</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pledge-list">
                                        <!-- JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="empty-state-pledge" class="hidden p-10 text-center text-gray-400">
                                <i class="fa-solid fa-file-invoice-dollar text-4xl mb-3"></i>
                                <p>目前沒有質押紀錄</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeAlert()"></div>
        <div class="relative w-full max-w-sm mx-auto mt-40 bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in p-6">
            <div class="text-center">
                <i class="fa-solid fa-circle-exclamation text-4xl text-amber-500 mb-4"></i>
                <h3 class="text-lg font-bold text-gray-800 mb-2" id="alert-title">系統訊息</h3>
                <p class="text-sm text-gray-600 mb-6 text-left whitespace-pre-wrap bg-gray-50 p-3 rounded border border-gray-100 font-mono" id="alert-message"></p>
                <div class="max-h-64 overflow-y-auto mb-4 text-left bg-gray-50 p-2 rounded border border-gray-200 hidden" id="json-debug-container">
                    <pre class="text-xs text-gray-600 font-mono whitespace-pre-wrap" id="json-debug-content"></pre>
                </div>
                <button onclick="closeAlert()" class="w-full bg-gray-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 hover:bg-gray-900 transition-colors">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeConfirm()"></div>
        <div class="relative w-full max-w-sm mx-auto mt-40 bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in p-6">
            <div class="text-center">
                <i class="fa-solid fa-circle-question text-4xl text-blue-500 mb-4"></i>
                <h3 class="text-lg font-bold text-gray-800 mb-2">確認操作</h3>
                <p class="text-sm text-gray-600 mb-6" id="confirm-message">確定要執行此操作嗎？</p>
                <div class="flex gap-3">
                    <button onclick="closeConfirm()" class="flex-1 bg-gray-200 text-gray-800 font-medium rounded-lg text-sm px-5 py-2.5 hover:bg-gray-300 transition-colors">
                        取消
                    </button>
                    <button onclick="onConfirmYes()" class="flex-1 bg-blue-600 text-white font-medium rounded-lg text-sm px-5 py-2.5 hover:bg-blue-700 transition-colors">
                        確定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Data Sync (GAS) -->
    <div id="transaction-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeDataSyncModal()"></div>
        <div class="relative w-full max-w-lg mx-auto mt-20 bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0">
                <h3 class="font-bold text-gray-800">連結 Google Sheet 資料庫</h3>
                <button onclick="closeDataSyncModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Write to Sheet Section -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-gray-700 border-l-4 border-green-500 pl-2">
                        Google Apps Script 網址
                    </h4>
                    <div class="text-xs text-gray-600 bg-gray-50 p-3 rounded border border-gray-200 leading-relaxed">
                        請貼上已部署的 Google Apps Script 網頁應用程式網址。此連結將用於：
                        <ul class="list-disc list-inside mt-1 ml-1 text-gray-500">
                            <li>讀取「股票交易紀錄」</li>
                            <li>讀取「即時價格與beta」</li>
                            <li>讀取「銀行系統餘額」</li>
                            <li>讀取「質押借貸資料」</li>
                            <li>寫入交易、質押資料與更新銀行餘額</li>
                        </ul>
                    </div>
                    <input type="url" id="gas-url" placeholder="https://script.google.com/macros/s/.../exec" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5">
                    
                    <div class="flex gap-2 pt-2">
                        <button onclick="saveGasUrl()" class="flex-1 text-gray-700 bg-gray-100 hover:bg-gray-200 font-medium rounded-lg text-sm px-5 py-2 text-center border border-gray-200">
                            儲存設定
                        </button>
                        <button onclick="fetchDataFromGAS()" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex justify-center items-center">
                            <span id="btn-tx-fetch-text">立即讀取資料</span>
                            <i id="btn-tx-fetch-loading" class="fa-solid fa-circle-notch fa-spin ml-2 hidden"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Broker Logic ---
        function updateBrokerStyle(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const baseClasses = "w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5";
            const optionClasses = selectedOption.getAttribute('class') || "";
            selectElement.className = baseClasses + " " + optionClasses;
        }

        // --- Action Logic ---
        function updateActionStyle(selectElement) {
            const selectedValue = selectElement.value;
            const baseClasses = "w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5";
            let colorClass = "";
            if (selectedValue === 'BUY') {
                colorClass = "bg-red-600 text-white";
            } else if (selectedValue === 'SELL') {
                colorClass = "bg-green-600 text-white";
            }
            selectElement.className = baseClasses + " " + colorClass;
        }

        // --- Helper Function: Format Input as Financial Number ---
        function formatInput(input) {
            let val = parseFloat(input.value.replace(/,/g, ''));
            if (isNaN(val)) val = 0;
            input.value = val.toLocaleString('en-US', {maximumFractionDigits: 0}); 
        }

        // --- Helper Function: Safe Set Text ---
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        // --- Helper Function: Update PnL Element with Color ---
        function updatePnlElement(id, value, options = {}) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = formatMoney(value, options);
                el.className = `text-2xl lg:text-3xl font-bold ${getColorClass(value)}`;
            }
        }

        // --- Custom Alert/Confirm Logic ---
        function showAlert(title, message, jsonDebug = null) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').innerHTML = message.replace(/\n/g, '<br>');
            
            const debugContainer = document.getElementById('json-debug-container');
            const debugContent = document.getElementById('json-debug-content');
            
            if (jsonDebug) {
                debugContent.textContent = JSON.stringify(jsonDebug, null, 2);
                debugContainer.classList.remove('hidden');
            } else {
                debugContainer.classList.add('hidden');
            }
            
            document.getElementById('alert-modal').classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('alert-modal').classList.add('hidden');
        }

        let confirmCallback = null;
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerHTML = message.replace(/\n/g, '<br>');
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function onConfirmYes() {
            if (confirmCallback) confirmCallback();
            closeConfirm();
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        // --- Config: Categories ---
        const CATEGORY_MAP = {}; // Dynamic from Beta

        function getCategoryFromBeta(beta) {
            if (beta < 0.5) return '類現金';
            if (beta > 1.4) return '槓桿';
            return '原型';
        }

        const CATEGORY_COLORS = {
            '原型': '#3b82f6', // Blue
            '槓桿': '#a855f7', // Purple
            '類現金': '#22c55e', // Green
            '其他': '#9ca3af'  // Gray
        };

        // --- State Management ---
        let transactions = JSON.parse(localStorage.getItem('my_transactions')) || [];
        let currentPrices = JSON.parse(localStorage.getItem('my_current_prices')) || {};
        let otherCash = JSON.parse(localStorage.getItem('my_other_cash')) || { TWD: 0, USD: 0 };
        let liabilities = JSON.parse(localStorage.getItem('my_liabilities')) || { mortgage: 0, loan: 0, pledge: 0 };
        let symbolBetas = JSON.parse(localStorage.getItem('my_symbol_betas')) || {}; 
        let bankData = JSON.parse(localStorage.getItem('my_bank_data')) || []; 
        let pledgeData = JSON.parse(localStorage.getItem('my_pledge_data')) || []; // NEW
        
        let gasUrl = localStorage.getItem('my_gas_url') || '';         
        
        let exchangeRates = JSON.parse(localStorage.getItem('my_exchange_rates')) || {
            'USD': 32.5,
            'HKD': 4.1, 
            'JPY': 0.22,
            'TWD': 1
        };
        
        let rateMode = localStorage.getItem('my_rate_mode') || 'auto'; 
        let chartInstance = null;
        let isSoldOutExpanded = false; // State for sold out row visibility

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('t-date').valueAsDate = new Date();
            
            if(gasUrl) document.getElementById('gas-url').value = gasUrl;
            
            document.getElementById('rate-usd').value = exchangeRates['USD'];

            setRateMode(rateMode);

            // Init manual cash inputs
            const cashTwdInput = document.getElementById('cash-twd');
            cashTwdInput.value = otherCash.TWD;
            // Removed onblur from cash inputs as they are read-only
            // formatInput(cashTwdInput); 

            const cashUsdInput = document.getElementById('cash-usd');
            cashUsdInput.value = otherCash.USD;
            // formatInput(cashUsdInput);

            // Init liabilities inputs
            const liabMort = document.getElementById('liab-mortgage');
            liabMort.value = liabilities.mortgage;
            formatInput(liabMort);

            const liabLoan = document.getElementById('liab-loan');
            liabLoan.value = liabilities.loan;
            formatInput(liabLoan);
            
            const liabPledge = document.getElementById('liab-pledge');
            liabPledge.value = liabilities.pledge;
            // formatInput(liabPledge); // Pledge is now read-only

            updateBrokerStyle(document.getElementById('t-broker'));
            updateActionStyle(document.getElementById('t-action'));
            
            // Auto fetch DATA (Transactions + Prices + Beta) if GAS URL is present
            if (rateMode === 'auto' && gasUrl) {
                fetchDataFromGAS(true); // Silent mode fetch
            }

            renderTransactions();
            renderBankTable(); // Initial Render
            renderPledgeTable(); // Initial Render
        });

        // --- Beta Management ---
        function getBeta(symbol) {
            // Priority: GAS synced beta -> Default 1.0
            return symbolBetas[symbol] !== undefined ? symbolBetas[symbol] : 1.0;
        }

        // --- Navigation ---
        function switchTab(tabName) {
            const tabs = ['transactions', 'overview', 'bank', 'pledge']; // Added pledge
            tabs.forEach(t => {
                const section = document.getElementById(`view-${t}`);
                const btn = document.getElementById(`tab-btn-${t}`);
                if (section && btn) { // Add safety check
                     if (t === tabName) {
                        section.classList.remove('hidden');
                        section.classList.add('block');
                        btn.classList.remove('tab-inactive');
                        btn.classList.add('tab-active');
                    } else {
                        section.classList.add('hidden');
                        section.classList.remove('block');
                        btn.classList.add('tab-inactive');
                        btn.classList.remove('tab-active');
                    }
                }
            });

            if (tabName === 'overview') {
                 if (rateMode === 'auto') {
                    fetchRealTimeRate(); // Update USD rate
                }
                renderPortfolio();
            }
        }

        // --- Data Sync Modal Logic ---
        function openDataSyncModal() {
            document.getElementById('transaction-modal').classList.remove('hidden');
        }
        function closeDataSyncModal() {
            document.getElementById('transaction-modal').classList.add('hidden');
        }
        
        function saveGasUrl() {
            const url = document.getElementById('gas-url').value.trim();
            localStorage.setItem('my_gas_url', url);
            gasUrl = url;
            showToast('GAS 網址已儲存');
        }

        // --- Fetch Data from GAS ---
        async function fetchDataFromGAS(isSilent = false) {
            if (!gasUrl) {
                if(!isSilent) showAlert('提示', '請先輸入 Google Apps Script 網址');
                return;
            }

            const btnText = document.getElementById('btn-tx-fetch-text');
            const btnLoading = document.getElementById('btn-tx-fetch-loading');

            if(!isSilent && btnText) {
                btnText.textContent = '讀取中...';
                btnLoading.classList.remove('hidden');
            }

            try {
                // Fetch ALL types
                const response = await fetch(gasUrl);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤 (${response.status})`);
                }
                const json = await response.json();
                
                if (json.error) {
                    throw new Error(json.error);
                }

                if (!isSilent) {
                    if (!json.transactions && !json.marketData && !json.bankData && !json.dashboard && !json.pledgeData) {
                         showAlert('資料格式錯誤', 'JSON 格式不符，缺少必要欄位。', json);
                         return;
                    }
                }

                // Process Transactions
                if (json.transactions && Array.isArray(json.transactions)) {
                    processGASTransactions(json.transactions);
                }

                // Process Market Data
                if (json.marketData && Array.isArray(json.marketData)) {
                    processGASMarketData(json.marketData);
                }

                // Process Bank Data
                if (json.bankData && Array.isArray(json.bankData)) {
                    bankData = json.bankData;
                    localStorage.setItem('my_bank_data', JSON.stringify(bankData));
                    renderBankTable();
                }

                // Process Dashboard Data
                if (json.dashboard) {
                    processGASDashboardData(json.dashboard);
                }

                // Process Pledge Data (NEW)
                if (json.pledgeData && Array.isArray(json.pledgeData)) {
                    processGASPledgeData(json.pledgeData);
                }
                
                if (!isSilent) {
                    let msg = '資料同步成功！\n';
                    if(json.transactions) msg += `- 交易紀錄: ${json.transactions.length} 筆\n`;
                    if(json.marketData) msg += `- 市場數據: ${json.marketData.length} 筆\n`;
                    if(json.bankData) msg += `- 銀行資料: ${json.bankData.length} 筆\n`;
                    if(json.pledgeData) msg += `- 質押紀錄: ${json.pledgeData.length} 筆\n`;
                    if(json.dashboard && json.dashboard['匯率_USDTWD']) msg += `- 匯率更新: ${json.dashboard['匯率_USDTWD']}`;
                    
                    showToast(msg);
                    closeDataSyncModal();
                }

            } catch (error) {
                console.error(error);
                if (!isSilent) {
                    showAlert('同步失敗', error.message + '\n請確認 GAS 網址與部署權限。');
                }
            } finally {
                if(!isSilent && btnText) {
                    btnText.textContent = '立即讀取資料';
                    btnLoading.classList.add('hidden');
                }
            }
        }

        // New function to handle Dashboard Data (Exchange Rate)
        function processGASDashboardData(data) {
            if (data['匯率_USDTWD']) {
                const rate = parseFloat(data['匯率_USDTWD']);
                if (!isNaN(rate)) {
                    exchangeRates['USD'] = rate;
                    localStorage.setItem('my_exchange_rates', JSON.stringify(exchangeRates));
                    
                    if (rateMode === 'auto') {
                         document.getElementById('rate-usd').value = rate.toFixed(2);
                         renderPortfolio();
                    }
                }
            }
        }

        // ... processGASTransactions ...
        function processGASTransactions(data) {
             const newTransactions = [];
             data.forEach((row, index) => {
                const id = Date.now() + index;
                if(!row.date || !row.symbol) return;
                let dateIso = row.date;
                if (typeof row.date === 'string' && row.date.indexOf('T') > -1) {
                    const d = new Date(row.date);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dateIso = `${year}-${month}-${day}`;
                }
                let action = 'BUY';
                const actStr = String(row.action).toUpperCase();
                if (actStr === '賣' || actStr === 'SELL' || actStr === 'S') {
                    action = 'SELL';
                }
                newTransactions.push({
                    id: id,
                    date: dateIso,
                    broker: row.broker,
                    symbol: String(row.symbol).toUpperCase(),
                    action: action,
                    qty: parseFloat(row.qty),
                    price: parseFloat(row.price),
                    currency: row.currency || 'TWD'
                });
             });
             transactions = newTransactions;
             saveData();
             renderTransactions();
        }

        function processGASMarketData(data) {
            data.forEach(item => {
                const sym = String(item.symbol).toUpperCase();
                if (item.price) {
                    currentPrices[sym] = parseFloat(item.price);
                }
                if (item.beta !== undefined && item.beta !== "") {
                    symbolBetas[sym] = parseFloat(item.beta);
                }
            });
            localStorage.setItem('my_current_prices', JSON.stringify(currentPrices));
            localStorage.setItem('my_symbol_betas', JSON.stringify(symbolBetas));
            renderPortfolio();
        }

        function processGASPledgeData(data) {
            const newPledge = [];
            data.forEach((row, index) => {
                let dateIso = row.transferDate;
                if (typeof row.transferDate === 'string' && row.transferDate.indexOf('T') > -1) {
                    const d = new Date(row.transferDate);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dateIso = `${year}-${month}-${day}`;
                }
                
                let loanDateIso = row.loanDate;
                if (typeof row.loanDate === 'string' && row.loanDate.indexOf('T') > -1) {
                    const d = new Date(row.loanDate);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    loanDateIso = `${year}-${month}-${day}`;
                }

                 let repayDateIso = row.repaymentDate;
                if (typeof row.repaymentDate === 'string' && row.repaymentDate.indexOf('T') > -1) {
                    const d = new Date(row.repaymentDate);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    repayDateIso = `${year}-${month}-${day}`;
                }

                newPledge.push({
                    transferDate: dateIso,
                    symbol: row.symbol,
                    qty: row.qty,
                    broker: row.broker,
                    collateralValue: row.collateralValue,
                    loanDate: loanDateIso,
                    loanAmount: row.loanAmount,
                    rate: row.rate,
                    repaymentDate: repayDateIso
                });
            });
            pledgeData = newPledge;
            localStorage.setItem('my_pledge_data', JSON.stringify(pledgeData));
            renderPledgeTable();
        }

        // --- Bank Table Logic ---
        function renderBankTable() {
            const list = document.getElementById('bank-list');
            const emptyState = document.getElementById('empty-state-bank');
            if(!list) return;

            list.innerHTML = '';

            const totalUSD = bankData.reduce((sum, item) => sum + (parseFloat(item.usd) || 0), 0);
            const totalTWD = bankData.reduce((sum, item) => sum + (parseFloat(item.twd) || 0), 0);
            
            safeSetText('bank-total-usd', formatMoney(totalUSD, {maximumFractionDigits: 0}));
            safeSetText('bank-total-twd', formatMoney(totalTWD, {maximumFractionDigits: 0}));


            if (bankData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            bankData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                const createInput = (field, value) => {
                    const displayVal = formatMoney(value, {maximumFractionDigits: 0}); 
                    return `<input type="text" 
                        class="bank-input" 
                        value="${displayVal}" 
                        onfocus="this.value = this.value.replace(/,/g, '')" 
                        onblur="saveBankRow('${item.bank}', '${field}', this)"
                    >`;
                };

                row.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-800">${item.bank}</td>
                    <td class="px-6 py-4">${createInput('usd', item.usd)}</td>
                    <td class="px-6 py-4">${createInput('twd', item.twd)}</td>
                    <td class="px-6 py-4 text-red-500">${createInput('loan', item.loan)}</td>
                `;
                list.appendChild(row);
            });
        }

        async function saveBankRow(bankName, field, inputElement) {
            formatInput(inputElement);
            const val = parseFloat(inputElement.value.replace(/,/g, ''));
            
            const bankItem = bankData.find(b => b.bank === bankName);
            if (bankItem) {
                if (bankItem[field] === val) return; 
                bankItem[field] = val;
                localStorage.setItem('my_bank_data', JSON.stringify(bankData));
                renderBankTable();
            }

            if (gasUrl) {
                showToast(`正在儲存 ${bankName}...`);
                try {
                    const payload = {
                        type: 'updateBank',
                        bank: bankItem.bank,
                        usd: bankItem.usd,
                        twd: bankItem.twd,
                        loan: bankItem.loan
                    };

                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    showToast('儲存成功');
                } catch (e) {
                    console.error(e);
                    showToast('儲存至雲端失敗，但已存於本地');
                }
            }
        }

        // --- Pledge Logic (NEW) ---
        function calculatePledgeCollateral() {
            const symbol = document.getElementById('p-symbol').value.toUpperCase();
            const qty = parseFloat(document.getElementById('p-qty').value);
            const collateralInput = document.getElementById('p-collateral');
            
            if (symbol && qty && currentPrices[symbol]) {
                const val = Math.round(qty * currentPrices[symbol]);
                collateralInput.value = formatMoney(val, {maximumFractionDigits: 0});
            } else {
                collateralInput.value = '';
            }
        }

        function calculateRepaymentDate() {
            const loanDateVal = document.getElementById('p-loan-date').value;
            const repayInput = document.getElementById('p-repay-date');
            
            if (loanDateVal) {
                const date = new Date(loanDateVal);
                // Add 6 months
                date.setMonth(date.getMonth() + 6);
                // Subtract 1 day
                date.setDate(date.getDate() - 1);
                
                repayInput.valueAsDate = date;
            }
        }

        async function addPledgeTransaction(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-pledge-submit');
            const icon = document.getElementById('icon-pledge-loading');
            
            // Get values
            const transferDate = document.getElementById('p-transfer-date').value;
            const symbol = document.getElementById('p-symbol').value.toUpperCase();
            const qty = parseFloat(document.getElementById('p-qty').value);
            const broker = document.getElementById('p-broker').value;
            // Recalc collateral to be safe
            const collateralValue = Math.round(qty * (currentPrices[symbol] || 0)); 
            const loanDate = document.getElementById('p-loan-date').value;
            const loanAmount = parseFloat(document.getElementById('p-loan-amount').value);
            // Convert rate to decimal 0.0248 to store in sheet, user inputs 2.48
            const rate = parseFloat(document.getElementById('p-rate').value) / 100;
            const repaymentDate = document.getElementById('p-repay-date').value;
            const interest = 0; // Placeholder

            const newPledge = {
                transferDate, symbol, qty, broker, collateralValue, 
                loanDate, loanAmount, rate, repaymentDate, interest
            };

            // Local Update
            pledgeData.push(newPledge);
            localStorage.setItem('my_pledge_data', JSON.stringify(pledgeData));
            renderPledgeTable();

            // Clear Form
            document.getElementById('p-symbol').value = '';
            document.getElementById('p-qty').value = '';
            document.getElementById('p-collateral').value = '';
            document.getElementById('p-loan-amount').value = '';
            document.getElementById('p-rate').value = '';

            // GAS Sync
            if (gasUrl) {
                btn.disabled = true;
                icon.classList.remove('hidden');
                try {
                    const payload = {
                        type: 'addPledge',
                        ...newPledge
                    };
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    showToast('質押紀錄已新增並發送至 Google Sheet');
                } catch (error) {
                    console.error(error);
                    showAlert('寫入失敗', '寫入失敗，但已儲存至本地。');
                } finally {
                    btn.disabled = false;
                    icon.classList.add('hidden');
                }
            } else {
                showToast('已新增至本地');
            }
        }

        function renderPledgeTable() {
            const list = document.getElementById('pledge-list');
            const empty = document.getElementById('empty-state-pledge');
            if(!list) return;

            list.innerHTML = '';
            
            // Calculate Total Loan and Total Collateral for Maintenance Ratio
            let totalLoanAmount = 0;
            let totalCollateralValue = 0;

            pledgeData.forEach(p => {
                totalLoanAmount += parseFloat(p.loanAmount) || 0;
                // Use current price for real-time collateral value
                const currentPrice = currentPrices[p.symbol] || 0;
                totalCollateralValue += (parseFloat(p.qty) || 0) * currentPrice;
            });
            
            // Calculate Overall Ratio
            let overallRatio = 0;
            if (totalLoanAmount > 0) {
                overallRatio = (totalCollateralValue / totalLoanAmount) * 100;
            }
            
            // Update Pledge Summary Cards
            safeSetText('pledge-total-loan', formatMoney(totalLoanAmount, {maximumFractionDigits: 0}));
            const ratioEl = document.getElementById('pledge-overall-ratio');
            if(ratioEl) {
                ratioEl.textContent = overallRatio.toFixed(2) + '%';
                // Color coding for overall ratio
                ratioEl.className = "text-2xl lg:text-3xl font-bold " + (overallRatio < 130 ? "text-red-600" : (overallRatio < 166 ? "text-yellow-600" : "text-green-600"));
            }

            if (pledgeData.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            pledgeData.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                // Format Rate (0.0248 -> 2.48%)
                const rateVal = parseFloat(p.rate);
                let displayRateVal = rateVal;
                if(rateVal < 0.5) displayRateVal = rateVal * 100;
                
                // Calculate Interest
                const loanDate = new Date(p.loanDate);
                const today = new Date();
                const diffTime = today - loanDate;
                const diffDays = diffTime > 0 ? Math.ceil(diffTime / (1000 * 60 * 60 * 24)) : 0;
                const decimalRate = rateVal > 0.5 ? rateVal / 100 : rateVal;
                const interest = Math.round(p.loanAmount * decimalRate * (diffDays / 365));

                // Maintenance Ratio (Item level)
                const currentPrice = currentPrices[p.symbol] || 0;
                const currentCollateral = p.qty * currentPrice;
                let maintenanceRatio = 0;
                if(p.loanAmount > 0) {
                     maintenanceRatio = (currentCollateral / p.loanAmount) * 100;
                }
                
                let ratioClass = "text-green-600 font-bold";
                if(maintenanceRatio < 130) ratioClass = "text-red-600 font-bold";
                else if(maintenanceRatio < 140) ratioClass = "text-yellow-600 font-bold";

                row.innerHTML = `
                    <td class="px-4 py-3">${p.transferDate}</td>
                    <td class="px-4 py-3 font-bold">${p.symbol}</td>
                    <td class="px-4 py-3 text-right">${formatNumber(p.qty)}</td>
                    <td class="px-4 py-3 text-right">${formatMoney(currentCollateral, {maximumFractionDigits: 0})}</td>
                    <td class="px-4 py-3">${p.loanDate}</td>
                    <td class="px-4 py-3 text-right text-red-600 font-bold">${formatMoney(p.loanAmount, {maximumFractionDigits: 0})}</td>
                    <td class="px-4 py-3 text-right">${displayRateVal.toFixed(2)}%</td>
                    <td class="px-4 py-3 text-gray-500">${p.repaymentDate}</td>
                    <td class="px-4 py-3 text-right">${formatMoney(interest, {maximumFractionDigits: 0})}</td>
                    <td class="px-4 py-3 text-right ${ratioClass}">${maintenanceRatio.toFixed(2)}%</td>
                `;
                list.appendChild(row);
            });
        }


        // --- Transaction Functions ---
        async function addTransaction(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('btn-add-submit');
            const loadingIcon = document.getElementById('icon-upload-loading');
            const brokerSelect = document.getElementById('t-broker');
            const broker = brokerSelect.options[brokerSelect.selectedIndex].value;

            const newTx = {
                id: Date.now(),
                date: document.getElementById('t-date').value,
                action: document.getElementById('t-action').value,
                symbol: document.getElementById('t-symbol').value.toUpperCase().trim(),
                broker: broker,
                qty: parseFloat(document.getElementById('t-qty').value),
                price: parseFloat(document.getElementById('t-price').value),
                currency: document.getElementById('t-currency').value
            };

            transactions.push(newTx);
            saveData();
            renderTransactions();
            
            document.getElementById('t-symbol').value = '';
            document.getElementById('t-qty').value = '';
            document.getElementById('t-price').value = '';

            if (gasUrl) {
                submitBtn.disabled = true;
                loadingIcon.classList.remove('hidden');
                
                const sheetPayload = {
                    ...newTx,
                    action: newTx.action === 'BUY' ? '買' : '賣',
                    symbol: "'" + newTx.symbol
                };
                
                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(sheetPayload)
                    });
                    showToast('已新增並發送至 Google Sheet');
                } catch (error) {
                    console.error('GAS Sync Error:', error);
                    showAlert('寫入失敗', '寫入失敗，但已儲存至本地。');
                } finally {
                    submitBtn.disabled = false;
                    loadingIcon.classList.add('hidden');
                }
            } else {
                showToast('已新增至本地 (未設定 Google Sheet)');
            }
        }

        function deleteTransaction(id) {
            showConfirm('確定要刪除這筆紀錄嗎？\n(注意：這只會刪除本地紀錄，不會刪除 Google Sheet 上的資料)', () => {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
                renderPortfolio(); 
            });
        }

        function renderTransactions() {
            const list = document.getElementById('transaction-list');
            const countSpan = document.getElementById('tx-count');
            const emptyState = document.getElementById('empty-state-tx');

            list.innerHTML = '';
            const sortedTx = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedTx.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }
            countSpan.textContent = `${sortedTx.length} 筆`;
            sortedTx.forEach(tx => {
                const total = (tx.qty * tx.price).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
                const actionColor = tx.action === 'BUY' ? 'bg-red-600 text-white' : 'bg-green-600 text-white';
                const actionLabel = tx.action === 'BUY' ? '買入' : '賣出';
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 font-medium">${tx.date}</td>
                    <td class="px-6 py-4 font-bold text-blue-600">${tx.symbol} <span class="text-xs text-gray-400 font-normal block">${tx.broker || '-'}</span></td>
                    <td class="px-6 py-4"><span class="${actionColor} px-2 py-1 rounded text-xs font-bold">${actionLabel}</span></td>
                    <td class="px-6 py-4 text-right">${tx.qty.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right">${tx.price.toLocaleString()} <span class="text-xs text-gray-400">${tx.currency}</span></td>
                    <td class="px-6 py-4 text-right font-mono">${total}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteTransaction(${tx.id})" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        // ... (Existing Exchange Rate Logic) ...
        function setRateMode(mode) {
            rateMode = mode;
            localStorage.setItem('my_rate_mode', mode);
            
            const btnManual = document.getElementById('mode-btn-manual');
            const btnAuto = document.getElementById('mode-btn-auto');
            const inputUsd = document.getElementById('rate-usd');
            const autoControls = document.getElementById('auto-rate-controls');

            if (mode === 'manual') {
                btnManual.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-blue-100 text-blue-700 shadow-sm";
                btnAuto.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-transparent text-gray-500 hover:bg-gray-100";
                inputUsd.removeAttribute('readonly');
                inputUsd.classList.remove('bg-gray-100', 'text-gray-500');
                inputUsd.classList.add('bg-white', 'text-gray-900');
                autoControls.classList.add('hidden');
            } else {
                btnManual.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-transparent text-gray-500 hover:bg-gray-100";
                btnAuto.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-blue-100 text-blue-700 shadow-sm";
                inputUsd.setAttribute('readonly', true);
                inputUsd.classList.remove('bg-white', 'text-gray-900');
                inputUsd.classList.add('bg-gray-100', 'text-gray-500');
                autoControls.classList.remove('hidden');
                fetchRealTimeRate();
            }
        }

        async function fetchRealTimeRate() {
            if (rateMode !== 'auto') return;
            const icon = document.getElementById('icon-rate-refresh');
            const label = document.getElementById('rate-last-updated');
            icon.classList.add('fa-spin');
            label.textContent = '更新中...';
            const urls = ['https://open.er-api.com/v6/latest/USD','https://api.exchangerate-api.com/v4/latest/USD'];
            let success = false;
            for (const url of urls) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) continue; 
                    const data = await res.json();
                    if (data && data.rates && data.rates.TWD) {
                        let rate = data.rates.TWD;
                        rate = parseFloat(rate.toFixed(2));
                        exchangeRates['USD'] = rate;
                        localStorage.setItem('my_exchange_rates', JSON.stringify(exchangeRates));
                        document.getElementById('rate-usd').value = rate.toFixed(2);
                        const now = new Date();
                        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                        label.textContent = `更新於 ${timeStr}`;
                        renderPortfolio();
                        showToast(`匯率已更新: 1 USD = ${rate.toFixed(2)} TWD`);
                        success = true;
                        break; 
                    }
                } catch (err) { console.warn(`Failed to fetch from ${url}`, err); }
            }
            if (!success) label.textContent = '更新失敗';
            icon.classList.remove('fa-spin');
        }

        function updateExchangeRate(currency, value) {
            if (rateMode === 'auto' && currency === 'USD') return; 
            const rate = parseFloat(value);
            if(isNaN(rate) || rate <= 0) return;
            exchangeRates[currency] = rate;
            localStorage.setItem('my_exchange_rates', JSON.stringify(exchangeRates));
            renderPortfolio(); 
        }

        // REMOVED: saveManualAssetsAndRecalculate() - Assets now automated

        function toggleSoldOutRows() {
            isSoldOutExpanded = !isSoldOutExpanded;
            renderPortfolio();
        }

        function calculatePortfolioData() {
            const portfolio = {};
            let totalPortfolioValueTWD = 0; 
            let totalInvestedCostTWD = 0;
            let totalGlobalRealizedPnLTWD = 0;

            const categoryTotals = { '原型': 0, '槓桿': 0, '類現金': 0, '其他': 0 };
            const sortedTx = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedTx.forEach(tx => {
                if (!portfolio[tx.symbol]) {
                    const symbolBeta = getBeta(tx.symbol);
                    const category = getCategoryFromBeta(symbolBeta);
                    portfolio[tx.symbol] = {
                        symbol: tx.symbol, currency: tx.currency, beta: symbolBeta, category: category,
                        inventory: 0, totalCost: 0, totalBuyQty: 0, totalBuyAmt: 0, soldQty: 0, realizedPnL: 0, avgCost: 0
                    };
                }
                const p = portfolio[tx.symbol];
                if (tx.action === 'BUY') {
                    p.inventory += tx.qty;
                    p.totalCost += (tx.qty * tx.price);
                    p.totalBuyQty += tx.qty;
                    p.totalBuyAmt += (tx.qty * tx.price);
                    if (p.inventory > 0) p.avgCost = p.totalCost / p.inventory;
                } else if (tx.action === 'SELL') {
                    const costBasis = p.avgCost * tx.qty;
                    const revenue = tx.price * tx.qty;
                    const profit = revenue - costBasis;
                    p.realizedPnL += profit;
                    p.inventory -= tx.qty;
                    p.totalCost -= costBasis;
                    p.soldQty += tx.qty;
                    if (p.inventory <= 0.000001) { p.inventory = 0; p.totalCost = 0; p.avgCost = 0; }
                }
            });

            const result = Object.values(portfolio).map(p => {
                let currentPrice = currentPrices[p.symbol];
                if (currentPrice === undefined || currentPrice === null) {
                     const lastTx = transactions.filter(t => t.symbol === p.symbol).sort((a,b) => b.id - a.id)[0];
                     currentPrice = lastTx ? lastTx.price : 0;
                }
                const marketValue = p.inventory * currentPrice;
                const unrealizedPnL = marketValue - p.totalCost;
                const roi = p.totalCost > 0 ? (unrealizedPnL / p.totalCost) * 100 : 0;
                const rate = exchangeRates[p.currency] || 1;
                const marketValueTWD = marketValue * rate;
                const unrealizedPnLTWD = unrealizedPnL * rate;
                const tooltipInfo = `${formatMoney(unrealizedPnL)} ${p.currency} x ${rate} = ${formatMoney(unrealizedPnLTWD)}`;
                
                p.beta = getBeta(p.symbol);
                p.category = getCategoryFromBeta(p.beta);

                if(p.inventory > 0) {
                    totalPortfolioValueTWD += marketValueTWD;
                    totalInvestedCostTWD += (p.totalCost * rate);
                    if(categoryTotals[p.category] !== undefined) categoryTotals[p.category] += marketValueTWD;
                    else categoryTotals['其他'] += marketValueTWD;
                }
                totalGlobalRealizedPnLTWD += (p.realizedPnL * rate);

                return { ...p, currentPrice, marketValue, unrealizedPnL, unrealizedPnLTWD, tooltipInfo, roi, marketValueTWD };
            });

            // Calculate manual cash & bank cash
            const rateUsd = exchangeRates['USD'] || 1;
            
            // New: Bank Data cash sum
            let bankCashTWD = 0;
            if (bankData.length > 0) {
                bankData.forEach(b => {
                    bankCashTWD += (b.twd || 0) + ((b.usd || 0) * rateUsd);
                });
            } else {
                 // Fallback to manual if no bank data
                 bankCashTWD = (otherCash.TWD || 0) + ((otherCash.USD || 0) * rateUsd);
            }

            categoryTotals['類現金'] += bankCashTWD;
            const totalAssetsValue = totalPortfolioValueTWD + bankCashTWD;

            result.forEach(p => {
                p.allocation = totalPortfolioValueTWD > 0 ? (p.marketValueTWD / totalPortfolioValueTWD) * 100 : 0;
            });
            result.sort((a, b) => b.allocation - a.allocation);

            let totalBeta = 0;
            result.forEach(p => {
                if (p.inventory > 0) {
                    const weight = totalAssetsValue > 0 ? (p.marketValueTWD / totalAssetsValue) : 0;
                    totalBeta += (weight * p.beta);
                }
            });

            const catPcts = {
                '原型': totalAssetsValue > 0 ? categoryTotals['原型'] / totalAssetsValue : 0,
                '槓桿': totalAssetsValue > 0 ? categoryTotals['槓桿'] / totalAssetsValue : 0,
                '類現金': totalAssetsValue > 0 ? categoryTotals['類現金'] / totalAssetsValue : 0,
                '其他': totalAssetsValue > 0 ? categoryTotals['其他'] / totalAssetsValue : 0,
            };

            return { 
                items: result, 
                totalValue: totalPortfolioValueTWD, 
                totalCost: totalInvestedCostTWD,
                totalRealized: totalGlobalRealizedPnLTWD,
                categoryTotals: categoryTotals, 
                catPcts: catPcts, 
                beta: totalBeta,
                bankCashTWD: bankCashTWD // Export for render
            };
        }

        function renderPortfolio() {
            const data = calculatePortfolioData();
            const list = document.getElementById('portfolio-list');
            const emptyState = document.getElementById('empty-state-pf');

            const rateUsd = exchangeRates['USD'] || 1;
            // Use calculated bank cash from logic
            const totalCashTWD = data.bankCashTWD;
            
            // Calculate Liabilities from Bank Data for specific banks
            let bankMortgage = 0;
            let bankCreditLoan = 0;
            
            if (bankData.length > 0) {
                const fubon = bankData.find(b => b.bank === '台北富邦');
                if (fubon) bankMortgage = parseFloat(fubon.loan) || 0;
                
                const ctbc = bankData.find(b => b.bank === '中國信託');
                if (ctbc) bankCreditLoan = parseFloat(ctbc.loan) || 0;
            }
            
            // Calculate Pledge Loan Total from Pledge Data
            const totalPledgeLoan = pledgeData.reduce((sum, p) => sum + (parseFloat(p.loanAmount) || 0), 0);
            
            // Total Liabilities Sum
            const totalLiabilitiesTWD = bankMortgage + bankCreditLoan + totalPledgeLoan;
            
            // --- Dashboard Updates (FIXED: Force integer display) ---
            
            // 1. Assets Distribution
            safeSetText('dash-stock-value', formatMoney(data.totalValue, {maximumFractionDigits: 0}));
            safeSetText('dash-stock-cost', formatMoney(data.totalCost, {maximumFractionDigits: 0}));
            safeSetText('dash-cash-value', formatMoney(totalCashTWD, {maximumFractionDigits: 0}));

            // Update Cash Inputs (Read-only display)
            // Calculate separate totals for display
            let displayTWD = 0;
            let displayUSD = 0;
            if (bankData.length > 0) {
                 bankData.forEach(b => {
                     displayTWD += (b.twd || 0);
                     displayUSD += (b.usd || 0);
                 });
            } else {
                displayTWD = otherCash.TWD;
                displayUSD = otherCash.USD;
            }
            document.getElementById('cash-twd').value = formatMoney(displayTWD, {maximumFractionDigits: 0});
            document.getElementById('cash-usd').value = formatMoney(displayUSD, {maximumFractionDigits: 0});

            // Update Liability Inputs (Read-only for all)
            document.getElementById('liab-mortgage').value = formatMoney(bankMortgage, {maximumFractionDigits: 0});
            document.getElementById('liab-loan').value = formatMoney(bankCreditLoan, {maximumFractionDigits: 0});
            document.getElementById('liab-pledge').value = formatMoney(totalPledgeLoan, {maximumFractionDigits: 0});

            // 3. Balance Sheet
            const totalAssets = data.totalValue + totalCashTWD;
            safeSetText('dash-total-assets', formatMoney(totalAssets, {maximumFractionDigits: 0}));
            safeSetText('dash-liabilities', formatMoney(totalLiabilitiesTWD, {maximumFractionDigits: 0}));

            // 4. Net Worth
            const netWorth = totalAssets - totalLiabilitiesTWD;
            safeSetText('dash-net-worth', formatMoney(netWorth, {maximumFractionDigits: 0}));

            // 2. Performance (PnL)
            const totalUnrealizedTWD = data.totalValue - data.totalCost; 
            const totalRealizedTWD = data.totalRealized;
            const totalCombinedPnL = totalUnrealizedTWD + totalRealizedTWD;

            updatePnlElement('total-unrealized-pnl', totalUnrealizedTWD, {maximumFractionDigits: 0});
            updatePnlElement('total-realized-pnl', totalRealizedTWD, {maximumFractionDigits: 0});
            updatePnlElement('total-combined-pnl', totalCombinedPnL, {maximumFractionDigits: 0});

            // Analysis Stats (FIXED: Force integer display for amounts)
            document.getElementById('stat-proto-val').textContent = (data.catPcts['原型'] * 100).toFixed(1) + '%';
            document.getElementById('stat-proto-amt').textContent = formatMoney(data.categoryTotals['原型'], {maximumFractionDigits: 0});
            
            document.getElementById('stat-lev-val').textContent = (data.catPcts['槓桿'] * 100).toFixed(1) + '%';
            document.getElementById('stat-lev-amt').textContent = formatMoney(data.categoryTotals['槓桿'], {maximumFractionDigits: 0});
            
            document.getElementById('stat-cash-val').textContent = (data.catPcts['類現金'] * 100).toFixed(1) + '%';
            document.getElementById('stat-cash-amt').textContent = formatMoney(data.categoryTotals['類現金'], {maximumFractionDigits: 0});

            document.getElementById('stat-beta').textContent = data.beta.toFixed(2);

            updateAllocationChart(data.categoryTotals);
            
            list.innerHTML = '';

            if (data.items.length === 0) {
                // emptyState.classList.remove('hidden'); // Removed due to potential issues
                return;
            }
            // emptyState.classList.add('hidden'); // Removed due to potential issues

            // Split items into active and sold out
            const activeItems = data.items.filter(p => p.inventory > 0.000001);
            const soldItems = data.items.filter(p => p.inventory <= 0.000001);

            // Render Active Items
            activeItems.forEach(p => {
                const isHold = true; // Fix: Explicitly set isHold for active items
                const roiClass = getColorClass(p.roi);
                const pnlClass = getColorClass(p.unrealizedPnLTWD); // Use TWD Value for color
                const realizedClass = getColorClass(p.realizedPnL);
                const catColor = CATEGORY_COLORS[p.category] || '#9ca3af';

                // Add Tooltips for transparency
                const avgCostTooltip = `總成本: ${formatMoney(p.totalCost)}`;

                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50 transition-colors';
                
                // Removed the Beta Input Column from Table
                row.innerHTML = `
                    <td class="px-4 py-4">
                        <span class="px-2 py-1 rounded text-xs text-white font-bold whitespace-nowrap" style="background-color: ${catColor}">
                            ${p.category}
                        </span>
                    </td>
                    <td class="px-4 py-4 font-bold text-gray-800">
                        ${p.symbol} 
                        <span class="text-xs text-gray-400 font-normal ml-1">${p.currency}</span>
                    </td>
                    <td class="px-4 py-4 text-right ${isHold ? 'font-bold' : 'text-gray-300'}">
                        ${formatNumber(p.inventory)}
                    </td>
                    <td class="px-4 py-4 text-right bg-yellow-50 border-l border-yellow-100 relative group">
                        <span class="font-mono text-gray-700">${formatMoney(p.currentPrice, {maximumFractionDigits: 2})}</span>
                    </td>
                    <td class="px-4 py-4 text-right font-mono font-medium text-gray-700">
                        ${isHold ? formatMoney(p.marketValue, {maximumFractionDigits: 0}) : '-'}
                    </td>
                    <td class="px-4 py-4 text-right text-gray-500 text-xs" title="${avgCostTooltip}">
                        ${isHold ? formatMoney(p.avgCost) : '-'}
                    </td>
                    <td class="px-4 py-4 text-right font-medium ${pnlClass}" title="${p.tooltipInfo}">
                        ${isHold ? formatMoney(p.unrealizedPnLTWD, {maximumFractionDigits: 0}) : '-'}
                    </td>
                    <td class="px-4 py-4 text-right font-bold ${roiClass}">
                        ${isHold ? p.roi.toFixed(2) + '%' : '-'}
                    </td>
                    <td class="px-4 py-4 text-right text-xs text-gray-500">
                        ${isHold ? p.allocation.toFixed(1) + '%' : '0.0%'}
                    </td>
                `;
                list.appendChild(row);
            });

            // Render Sold Out Toggle & Items
            if (soldItems.length > 0) {
                // Separator Row
                const separatorRow = document.createElement('tr');
                separatorRow.className = 'bg-gray-100 cursor-pointer hover:bg-gray-200 transition-colors';
                separatorRow.onclick = toggleSoldOutRows;
                separatorRow.innerHTML = `
                    <td colspan="9" class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                        <i class="fa-solid fa-chevron-${isSoldOutExpanded ? 'up' : 'down'} mr-2"></i>
                        已清倉項目 (${soldItems.length} 筆)
                    </td>
                `;
                list.appendChild(separatorRow);

                if (isSoldOutExpanded) {
                    soldItems.forEach(p => {
                        const realizedClass = getColorClass(p.realizedPnL);
                        const catColor = CATEGORY_COLORS[p.category] || '#9ca3af';

                        const row = document.createElement('tr');
                        row.className = 'bg-gray-50 border-b text-gray-400';
                        
                        row.innerHTML = `
                            <td class="px-4 py-4 opacity-50">
                                <span class="px-2 py-1 rounded text-xs text-white font-bold whitespace-nowrap opacity-50" style="background-color: ${catColor}">
                                    ${p.category}
                                </span>
                            </td>
                            <td class="px-4 py-4 font-medium opacity-75">
                                ${p.symbol} 
                                <span class="text-xs font-normal ml-1">${p.currency}</span>
                            </td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                        `;
                        list.appendChild(row);
                    });
                }
            }
        }
        
        // ... (Chart and Utility functions remain same) ...
        function updateAllocationChart(totals) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            const labels = ['原型', '槓桿', '類現金', '其他'];
            const dataValues = labels.map(l => totals[l]);
            const colors = labels.map(l => CATEGORY_COLORS[l]);
            if (chartInstance) chartInstance.destroy();
            if (Object.values(totals).reduce((a, b) => a + b, 0) === 0) return;
            const pieLabelsLinePlugin = {
                id: 'pieLabelsLine',
                afterDraw(chart) {
                    const { ctx, chartArea: { width, height } } = chart;
                    chart.data.datasets.forEach((dataset, i) => {
                        chart.getDatasetMeta(i).data.forEach((datapoint, index) => {
                            const value = dataset.data[index];
                            if (value <= 0) return;
                            const { x, y } = datapoint.tooltipPosition();
                            const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                            const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                            const angle = Math.atan2(y - centerY, x - centerX);
                            const outerRadius = datapoint.outerRadius;
                            const lineStartRadius = outerRadius;
                            const lineEndRadius = outerRadius + 20; 
                            const xStart = centerX + Math.cos(angle) * lineStartRadius;
                            const yStart = centerY + Math.sin(angle) * lineStartRadius;
                            const xEnd = centerX + Math.cos(angle) * lineEndRadius;
                            const yEnd = centerY + Math.sin(angle) * lineEndRadius;
                            ctx.beginPath();
                            ctx.moveTo(xStart, yStart);
                            ctx.lineTo(xEnd, yEnd);
                            const isRight = xEnd > centerX;
                            const xText = isRight ? xEnd + 10 : xEnd - 10;
                            ctx.lineTo(xText, yEnd);
                            ctx.strokeStyle = '#666';
                            ctx.stroke();
                            const total = dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                            const labelText = `${chart.data.labels[index]} ${percentage}`;
                            ctx.font = '11px Arial';
                            ctx.fillStyle = '#333';
                            ctx.textAlign = isRight ? 'left' : 'right';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(labelText, isRight ? xText + 5 : xText - 5, yEnd);
                        });
                    });
                }
            };
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: dataValues, backgroundColor: colors, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, layout: { padding: 40 }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { const val = context.raw; const total = context.chart._metasets[context.datasetIndex].total; const pct = ((val / total) * 100).toFixed(1) + '%'; return `${context.label}: ${formatMoney(val)} (${pct})`; } } } } },
                plugins: [pieLabelsLinePlugin]
            });
        }
        // ... (Rest of utilities) ...
        function updatePrice(symbol, newPrice) {
            currentPrices[symbol] = parseFloat(newPrice);
            localStorage.setItem('my_current_prices', JSON.stringify(currentPrices));
            renderPortfolio(); 
        }

        function saveData() {
            localStorage.setItem('my_transactions', JSON.stringify(transactions));
        }

        function confirmClearAllData() {
            showConfirm('警告：這將刪除所有交易紀錄與價格設定，且無法復原。確定嗎？', () => {
                localStorage.removeItem('my_transactions');
                localStorage.removeItem('my_current_prices');
                localStorage.removeItem('my_sheet_url');
                localStorage.removeItem('my_tx_sheet_url');
                localStorage.removeItem('my_gas_url'); 
                localStorage.removeItem('my_exchange_rates');
                localStorage.removeItem('my_other_cash'); 
                localStorage.removeItem('my_liabilities'); 
                localStorage.removeItem('my_symbol_betas'); // Clear betas
                localStorage.removeItem('my_bank_data');
                localStorage.removeItem('my_pledge_data');
                transactions = [];
                currentPrices = {};
                symbolBetas = {};
                bankData = [];
                pledgeData = [];
                renderTransactions();
                renderPortfolio();
                renderBankTable();
                renderPledgeTable();
                showToast('所有資料已清除');
            });
        }

        function formatMoney(num, options) {
            if (num === undefined || num === null) return '0';
            const defaultOptions = {minimumFractionDigits: 0, maximumFractionDigits: 2};
            const finalOptions = { ...defaultOptions, ...options };
            return num.toLocaleString(undefined, finalOptions);
        }

        function formatNumber(num) {
             return num.toLocaleString(undefined, {maximumFractionDigits: 4});
        }

        function getColorClass(val) {
            if (val > 0) return 'text-red-500'; 
            if (val < 0) return 'text-green-500'; 
            return 'text-gray-400';
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = 'fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm animate-bounce z-50';
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>
