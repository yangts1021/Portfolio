<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資組合與交易紀錄追蹤</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        .tab-inactive {
            color: #6b7280;
        }
        .tab-inactive:hover {
            color: #374151;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Custom Broker Styles */
        option.broker-cathay { background-color: #16a34a; color: white; }
        option.broker-fubon { background-color: #60a5fa; color: white; }
        option.broker-yuanta { background-color: #1e40af; color: white; }
        option.broker-gray { background-color: #e5e7eb; color: #1f2937; }

        /* Custom Action Styles */
        option.action-buy { background-color: #dc2626; color: white; }
        option.action-sell { background-color: #16a34a; color: white; }

        /* Tooltip style */
        [title] { cursor: help; }
        
        /* JSON Debug Area */
        .json-debug {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #334155;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 flex-none z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-tight">MyPortfolio</span>
                </div>
                <div class="flex space-x-4 md:space-x-8 items-center overflow-x-auto">
                    <button onclick="switchTab('transactions')" id="tab-btn-transactions" class="tab-active px-2 md:px-3 py-5 text-sm font-medium transition-colors duration-150 whitespace-nowrap">
                        <i class="fa-solid fa-pen-to-square mr-2"></i>交易紀錄
                    </button>
                    <button onclick="switchTab('overview')" id="tab-btn-overview" class="tab-inactive px-2 md:px-3 py-5 text-sm font-medium transition-colors duration-150 whitespace-nowrap">
                        <i class="fa-solid fa-gauge-high mr-2"></i>資產總覽
                    </button>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4 ml-auto">
                     <button onclick="openDataSyncModal()" class="text-blue-500 hover:text-blue-700 text-sm flex items-center bg-blue-50 px-3 py-2 rounded-lg transition-colors" title="連結 Google Sheet">
                        <i class="fa-brands fa-google mr-1"></i> <span class="hidden sm:inline ml-1">讀取交易資料</span>
                    </button>
                    <button onclick="confirmClearAllData()" class="text-red-500 hover:text-red-700 text-sm px-2" title="清除所有資料">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6">
        <div class="max-w-7xl mx-auto space-y-6">

            <!-- Tab 1: Transactions -->
            <div id="view-transactions" class="block animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Input Form -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 sticky top-6">
                            <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                                <i class="fa-solid fa-plus-circle text-blue-500 mr-2"></i> 新增交易
                            </h2>
                            <form id="transactionForm" onsubmit="addTransaction(event)" class="space-y-4">
                                <!-- Date & Action -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">日期</label>
                                        <input type="date" id="t-date" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">動作</label>
                                        <select id="t-action" required onchange="updateActionStyle(this)" class="w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                            <option value="BUY" class="bg-red-600 text-white action-buy">買入 (Buy)</option>
                                            <option value="SELL" class="bg-green-600 text-white action-sell">賣出 (Sell)</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Symbol & Broker -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">代碼 (Symbol)</label>
                                        <input type="text" id="t-symbol" placeholder="例如: 2330, AAPL" required class="uppercase w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">券商</label>
                                        <select id="t-broker" onchange="updateBrokerStyle(this)" class="w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                            <option value="國泰證券" class="bg-green-600 text-white broker-cathay">國泰證券</option>
                                            <option value="富邦證券" class="bg-blue-400 text-white broker-fubon">富邦證券</option>
                                            <option value="元大證券" class="bg-blue-800 text-white broker-yuanta">元大證券</option>
                                            <option value="台北富邦" class="bg-gray-200 text-gray-800 broker-gray">台北富邦</option>
                                            <option value="Firstrade" class="bg-gray-200 text-gray-800 broker-gray">Firstrade</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Qty & Price -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">股數</label>
                                        <input type="number" id="t-qty" step="0.0001" min="0.0001" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">成交單價</label>
                                        <input type="number" id="t-price" step="0.0001" min="0" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    </div>
                                </div>
                                <!-- Currency -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">幣別</label>
                                    <select id="t-currency" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="TWD">TWD (新台幣)</option>
                                        <option value="USD">USD (美金)</option>
                                        <option value="HKD">HKD (港幣)</option>
                                        <option value="JPY">JPY (日圓)</option>
                                    </select>
                                </div>
                                <!-- Submit -->
                                <button type="submit" id="btn-add-submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all flex justify-center items-center">
                                    <span>新增紀錄</span>
                                    <i id="icon-upload-loading" class="fa-solid fa-circle-notch fa-spin ml-2 hidden"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- History List -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700">交易歷史明細</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full" id="tx-count">0 筆</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto flex-1">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">日期</th>
                                            <th scope="col" class="px-6 py-3">代碼</th>
                                            <th scope="col" class="px-6 py-3">動作</th>
                                            <th scope="col" class="px-6 py-3 text-right">股數</th>
                                            <th scope="col" class="px-6 py-3 text-right">單價</th>
                                            <th scope="col" class="px-6 py-3 text-right">總額</th>
                                            <th scope="col" class="px-6 py-3 text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-list">
                                        <!-- JS will populate this -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="empty-state-tx" class="hidden p-10 text-center text-gray-400">
                                <i class="fa-solid fa-receipt text-4xl mb-3"></i>
                                <p>目前沒有交易紀錄</p>
                                <button onclick="openDataSyncModal()" class="mt-4 text-blue-500 underline text-sm">從 Google Sheet 讀取資料</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Asset Overview -->
            <div id="view-overview" class="hidden animate-fade-in">
                <!-- Exchange Rate Settings -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-wrap gap-6 items-center text-sm">
                    <div class="flex justify-between items-center mb-3 w-full">
                        <div class="font-bold text-gray-700 flex items-center">
                            <i class="fa-solid fa-money-bill-transfer mr-2 text-blue-500"></i> 
                            匯率設定 (USD/TWD)
                        </div>
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button onclick="setRateMode('manual')" id="mode-btn-manual" class="px-3 py-1 text-xs font-medium rounded-md transition-all">手動</button>
                            <button onclick="setRateMode('auto')" id="mode-btn-auto" class="px-3 py-1 text-xs font-medium rounded-md transition-all">自動抓取</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-gray-500 font-medium">USD 匯率</label>
                            <input type="number" id="rate-usd" value="32.5" step="0.01" onchange="updateExchangeRate('USD', this.value)" class="w-24 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 p-1 text-right font-mono font-bold">
                        </div>
                        <div id="auto-rate-controls" class="hidden flex items-center gap-2">
                            <button onclick="fetchRealTimeRate()" class="text-blue-600 hover:text-blue-800 text-xs flex items-center">
                                <i id="icon-rate-refresh" class="fa-solid fa-rotate-right mr-1"></i> 立即更新
                            </button>
                            <span id="rate-last-updated" class="text-xs text-gray-400"></span>
                        </div>
                    </div>
                </div>

                <!-- Manual Input Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-sm">
                        <div class="font-bold text-gray-700 flex items-center mb-3">
                            <i class="fa-solid fa-piggy-bank mr-2 text-yellow-500"></i> 其他類現金資產
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">TWD</label>
                                <input type="text" inputmode="decimal" id="cash-twd" value="0" onfocus="this.value = this.value.replace(/,/g, '')" onblur="formatInput(this)" class="w-32 bg-yellow-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-yellow-500 focus:border-yellow-500 p-1 text-right font-mono font-bold">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">USD</label>
                                <input type="text" inputmode="decimal" id="cash-usd" value="0" onfocus="this.value = this.value.replace(/,/g, '')" onblur="formatInput(this)" class="w-32 bg-yellow-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-yellow-500 focus:border-yellow-500 p-1 text-right font-mono font-bold">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-sm">
                        <div class="font-bold text-gray-700 flex items-center mb-3">
                            <i class="fa-solid fa-money-check-dollar mr-2 text-red-500"></i> 負債 (手動輸入 - TWD)
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">房貸</label>
                                <input type="text" inputmode="decimal" id="liab-mortgage" value="0" onfocus="this.value = this.value.replace(/,/g, '')" onblur="formatInput(this)" class="w-32 bg-red-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-red-500 focus:border-red-500 p-1 text-right font-mono font-bold">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">信貸</label>
                                <input type="text" inputmode="decimal" id="liab-loan" value="0" onfocus="this.value = this.value.replace(/,/g, '')" onblur="formatInput(this)" class="w-32 bg-red-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-red-500 focus:border-red-500 p-1 text-right font-mono font-bold">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-gray-500 font-medium">股票質押</label>
                                <input type="text" inputmode="decimal" id="liab-pledge" value="0" onfocus="this.value = this.value.replace(/,/g, '')" onblur="formatInput(this)" class="w-32 bg-red-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-red-500 focus:border-red-500 p-1 text-right font-mono font-bold">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mb-6">
                    <button onclick="saveManualAssetsAndRecalculate()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition-colors shadow-sm flex items-center">
                        <i class="fa-solid fa-calculator mr-2"></i> 確認並重新計算
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">證券市值</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-stock-value">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <!-- Added title attribute for tooltip -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center" title="計算公式：Σ(現有庫存股數 × 平均成本)。&#10;注意：賣出股票後，該部位成本會從此處移除，轉為已實現損益與現金。">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總投入成本 (證券) <i class="fa-regular fa-circle-question text-gray-400 ml-1"></i></div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-stock-cost">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">其他類現金</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-cash-value">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">證券未實現損益</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="total-unrealized-pnl">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">證券已實現總損益</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="total-realized-pnl">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center border-l-4 border-l-blue-400">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總損益 (已實現+未實現)</div>
                        <div class="text-2xl lg:text-3xl font-bold" id="total-combined-pnl">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                     <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總資產 (股票+現金)</div>
                        <div class="text-2xl lg:text-3xl font-bold text-gray-800" id="dash-total-assets">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center border-l-4 border-l-red-400">
                        <div class="text-gray-500 text-xs font-medium uppercase tracking-wider mb-1">總負債</div>
                        <div class="text-2xl lg:text-3xl font-bold text-red-600" id="dash-liabilities">--</div>
                        <div class="text-xs text-gray-400 mt-1">TWD</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-6 rounded-xl shadow-md text-center text-white">
                        <div class="text-blue-100 text-sm font-medium uppercase tracking-wider mb-2">淨資產總額 (資產 - 負債)</div>
                        <div class="text-4xl lg:text-5xl font-bold" id="dash-net-worth">--</div>
                        <div class="text-blue-200 text-sm mt-2">TWD</div>
                    </div>
                </div>
                
                <!-- Beta & Allocation Chart Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 w-full text-left">資產配置 (圓餅圖)</h3>
                        <div class="w-full h-64 flex justify-center">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-sm font-bold text-gray-700">曝險分析 & Beta</h3>
                            <div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">Beta = (權重 × 個股Beta) 加總</div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                                <div class="text-xs text-blue-500 font-medium">原型</div>
                                <div class="text-lg font-bold text-gray-800" id="stat-proto-val">0%</div>
                                <div class="text-xs text-gray-400" id="stat-proto-amt">$0</div>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                                <div class="text-xs text-purple-500 font-medium">槓桿</div>
                                <div class="text-lg font-bold text-gray-800" id="stat-lev-val">0%</div>
                                <div class="text-xs text-gray-400" id="stat-lev-amt">$0</div>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                                <div class="text-xs text-green-500 font-medium">類現金</div>
                                <div class="text-lg font-bold text-gray-800" id="stat-cash-val">0%</div>
                                <div class="text-xs text-gray-400" id="stat-cash-amt">$0</div>
                            </div>
                            <div class="p-3 bg-gray-800 rounded-lg border border-gray-700 shadow-md">
                                <div class="text-xs text-gray-300 font-medium">投資組合 Beta</div>
                                <div class="text-2xl font-bold text-white mt-1" id="stat-beta">0.00</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><i class="fa-solid fa-circle-info mr-1"></i> <strong>自動分類規則 (由 GAS 資料決定 Beta)：</strong></p>
                            <p class="ml-4">Beta &lt; 0.5 &rarr; <span class="text-green-600 font-bold">類現金</span></p>
                            <p class="ml-4">0.5 &le; Beta &le; 1.4 &rarr; <span class="text-blue-600 font-bold">原型</span></p>
                            <p class="ml-4">Beta &gt; 1.4 &rarr; <span class="text-purple-600 font-bold">槓桿</span></p>
                        </div>
                    </div>
                </div>

                <!-- Holdings Table Moved Here -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-6">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">持倉狀況 & 損益試算</h3>
                        <div class="flex items-center gap-2">
                             <!-- UPDATED: Refresh Button and Settings in one place -->
                             <button onclick="fetchDataFromGAS()" class="text-xs text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md transition-colors flex items-center shadow-sm">
                                <i class="fa-solid fa-rotate mr-1"></i> 更新資料
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">類別</th>
                                    <th class="px-4 py-3">代碼/幣別</th>
                                    <th class="px-4 py-3 text-right">庫存股數</th>
                                    <th class="px-4 py-3 text-right bg-yellow-50 border-l border-yellow-100 w-32">即時價格</th>
                                    <th class="px-4 py-3 text-right">倉位市值 (原幣)</th>
                                    <th class="px-4 py-3 text-right">平均成本 (原幣)</th>
                                    <th class="px-4 py-3 text-right">未實現損益 (TWD)</th>
                                    <th class="px-4 py-3 text-right">報酬率 %</th>
                                    <th class="px-4 py-3 text-right">占比 (TWD)</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-list"></tbody>
                        </table>
                    </div>
                     <div id="empty-state-pf" class="hidden p-10 text-center text-gray-400">
                        <i class="fa-solid fa-chart-pie text-4xl mb-3"></i>
                        <p>尚無持倉資料</p>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeAlert()"></div>
        <div class="relative w-full max-w-sm mx-auto mt-40 bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in p-6">
            <div class="text-center">
                <i class="fa-solid fa-circle-exclamation text-4xl text-amber-500 mb-4"></i>
                <h3 class="text-lg font-bold text-gray-800 mb-2" id="alert-title">系統訊息</h3>
                <p class="text-sm text-gray-600 mb-6 text-left whitespace-pre-wrap bg-gray-50 p-3 rounded border border-gray-100 font-mono" id="alert-message"></p>
                <div class="max-h-64 overflow-y-auto mb-4 text-left bg-gray-50 p-2 rounded border border-gray-200 hidden" id="json-debug-container">
                    <pre class="text-xs text-gray-600 font-mono whitespace-pre-wrap" id="json-debug-content"></pre>
                </div>
                <button onclick="closeAlert()" class="w-full bg-gray-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 hover:bg-gray-900 transition-colors">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeConfirm()"></div>
        <div class="relative w-full max-w-sm mx-auto mt-40 bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in p-6">
            <div class="text-center">
                <i class="fa-solid fa-circle-question text-4xl text-blue-500 mb-4"></i>
                <h3 class="text-lg font-bold text-gray-800 mb-2">確認操作</h3>
                <p class="text-sm text-gray-600 mb-6" id="confirm-message">確定要執行此操作嗎？</p>
                <div class="flex gap-3">
                    <button onclick="closeConfirm()" class="flex-1 bg-gray-200 text-gray-800 font-medium rounded-lg text-sm px-5 py-2.5 hover:bg-gray-300 transition-colors">
                        取消
                    </button>
                    <button onclick="onConfirmYes()" class="flex-1 bg-blue-600 text-white font-medium rounded-lg text-sm px-5 py-2.5 hover:bg-blue-700 transition-colors">
                        確定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Data Sync (GAS) -->
    <div id="transaction-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeDataSyncModal()"></div>
        <div class="relative w-full max-w-lg mx-auto mt-20 bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0">
                <h3 class="font-bold text-gray-800">連結 Google Sheet 資料庫</h3>
                <button onclick="closeDataSyncModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Write to Sheet Section -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-gray-700 border-l-4 border-green-500 pl-2">
                        Google Apps Script 網址
                    </h4>
                    <div class="text-xs text-gray-600 bg-gray-50 p-3 rounded border border-gray-200 leading-relaxed">
                        請貼上已部署的 Google Apps Script 網頁應用程式網址。此連結將用於：
                        <ul class="list-disc list-inside mt-1 ml-1 text-gray-500">
                            <li>讀取「股票交易紀錄」</li>
                            <li>讀取「即時價格與beta」</li>
                            <li>寫入新交易紀錄</li>
                        </ul>
                    </div>
                    <input type="url" id="gas-url" placeholder="https://script.google.com/macros/s/.../exec" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5">
                    
                    <div class="flex gap-2 pt-2">
                        <button onclick="saveGasUrl()" class="flex-1 text-gray-700 bg-gray-100 hover:bg-gray-200 font-medium rounded-lg text-sm px-5 py-2 text-center border border-gray-200">
                            儲存設定
                        </button>
                        <button onclick="fetchDataFromGAS()" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex justify-center items-center">
                            <span id="btn-tx-fetch-text">立即讀取資料</span>
                            <i id="btn-tx-fetch-loading" class="fa-solid fa-circle-notch fa-spin ml-2 hidden"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Broker Logic ---
        function updateBrokerStyle(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const baseClasses = "w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5";
            const optionClasses = selectedOption.getAttribute('class') || "";
            selectElement.className = baseClasses + " " + optionClasses;
        }

        // --- Action Logic ---
        function updateActionStyle(selectElement) {
            const selectedValue = selectElement.value;
            const baseClasses = "w-full border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5";
            let colorClass = "";
            if (selectedValue === 'BUY') {
                colorClass = "bg-red-600 text-white";
            } else if (selectedValue === 'SELL') {
                colorClass = "bg-green-600 text-white";
            }
            selectElement.className = baseClasses + " " + colorClass;
        }

        // --- Helper Function: Format Input as Financial Number ---
        function formatInput(input) {
            let val = parseFloat(input.value.replace(/,/g, ''));
            if (isNaN(val)) val = 0;
            input.value = val.toLocaleString('en-US', {maximumFractionDigits: 0}); 
        }

        // --- Helper Function: Safe Set Text ---
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        // --- Helper Function: Update PnL Element with Color ---
        function updatePnlElement(id, value, options = {}) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = formatMoney(value, options);
                el.className = `text-2xl lg:text-3xl font-bold ${getColorClass(value)}`;
            }
        }

        // --- Custom Alert/Confirm Logic ---
        function showAlert(title, message, jsonDebug = null) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').innerHTML = message.replace(/\n/g, '<br>');
            
            const debugContainer = document.getElementById('json-debug-container');
            const debugContent = document.getElementById('json-debug-content');
            
            if (jsonDebug) {
                debugContent.textContent = JSON.stringify(jsonDebug, null, 2);
                debugContainer.classList.remove('hidden');
            } else {
                debugContainer.classList.add('hidden');
            }
            
            document.getElementById('alert-modal').classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('alert-modal').classList.add('hidden');
        }

        let confirmCallback = null;
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').innerHTML = message.replace(/\n/g, '<br>');
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function onConfirmYes() {
            if (confirmCallback) confirmCallback();
            closeConfirm();
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        // --- Config: Categories ---
        const CATEGORY_MAP = {}; // Dynamic from Beta

        function getCategoryFromBeta(beta) {
            if (beta < 0.5) return '類現金';
            if (beta > 1.4) return '槓桿';
            return '原型';
        }

        const CATEGORY_COLORS = {
            '原型': '#3b82f6', // Blue
            '槓桿': '#a855f7', // Purple
            '類現金': '#22c55e', // Green
            '其他': '#9ca3af'  // Gray
        };

        // --- State Management ---
        let transactions = JSON.parse(localStorage.getItem('my_transactions')) || [];
        let currentPrices = JSON.parse(localStorage.getItem('my_current_prices')) || {};
        let otherCash = JSON.parse(localStorage.getItem('my_other_cash')) || { TWD: 0, USD: 0 };
        let liabilities = JSON.parse(localStorage.getItem('my_liabilities')) || { mortgage: 0, loan: 0, pledge: 0 };
        let symbolBetas = JSON.parse(localStorage.getItem('my_symbol_betas')) || {}; 
        
        let gasUrl = localStorage.getItem('my_gas_url') || '';         
        
        let exchangeRates = JSON.parse(localStorage.getItem('my_exchange_rates')) || {
            'USD': 32.5,
            'HKD': 4.1, 
            'JPY': 0.22,
            'TWD': 1
        };
        
        let rateMode = localStorage.getItem('my_rate_mode') || 'auto'; 
        let chartInstance = null;
        let isSoldOutExpanded = false; // State for sold out row visibility

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('t-date').valueAsDate = new Date();
            
            if(gasUrl) document.getElementById('gas-url').value = gasUrl;
            
            document.getElementById('rate-usd').value = exchangeRates['USD'];
            // document.getElementById('auto-fetch-prices').checked = (rateMode === 'auto'); // Removed check

            setRateMode(rateMode);

            // Init manual cash inputs
            const cashTwdInput = document.getElementById('cash-twd');
            cashTwdInput.value = otherCash.TWD;
            formatInput(cashTwdInput);

            const cashUsdInput = document.getElementById('cash-usd');
            cashUsdInput.value = otherCash.USD;
            formatInput(cashUsdInput);

            // Init liabilities inputs
            const liabMort = document.getElementById('liab-mortgage');
            liabMort.value = liabilities.mortgage;
            formatInput(liabMort);

            const liabLoan = document.getElementById('liab-loan');
            liabLoan.value = liabilities.loan;
            formatInput(liabLoan);
            
            const liabPledge = document.getElementById('liab-pledge');
            liabPledge.value = liabilities.pledge;
            formatInput(liabPledge);

            updateBrokerStyle(document.getElementById('t-broker'));
            updateActionStyle(document.getElementById('t-action'));
            
            // Auto fetch DATA (Transactions + Prices + Beta) if GAS URL is present
            if (rateMode === 'auto' && gasUrl) {
                fetchDataFromGAS(true); // Silent mode fetch
            }

            renderTransactions();
        });

        // --- Beta Management ---
        function getBeta(symbol) {
            // Priority: GAS synced beta -> Default 1.0
            return symbolBetas[symbol] !== undefined ? symbolBetas[symbol] : 1.0;
        }

        // --- Navigation ---
        function switchTab(tabName) {
            const tabs = ['transactions', 'overview'];
            tabs.forEach(t => {
                const section = document.getElementById(`view-${t}`);
                const btn = document.getElementById(`tab-btn-${t}`);
                if (section && btn) { // Add safety check
                     if (t === tabName) {
                        section.classList.remove('hidden');
                        section.classList.add('block');
                        btn.classList.remove('tab-inactive');
                        btn.classList.add('tab-active');
                    } else {
                        section.classList.add('hidden');
                        section.classList.remove('block');
                        btn.classList.add('tab-inactive');
                        btn.classList.remove('tab-active');
                    }
                }
            });

            if (tabName === 'overview') {
                 if (rateMode === 'auto') {
                    fetchRealTimeRate(); // Update USD rate
                }
                renderPortfolio();
            }
        }

        // --- Data Sync Modal Logic ---
        function openDataSyncModal() {
            document.getElementById('transaction-modal').classList.remove('hidden');
        }
        function closeDataSyncModal() {
            document.getElementById('transaction-modal').classList.add('hidden');
        }
        
        function saveGasUrl() {
            const url = document.getElementById('gas-url').value.trim();
            localStorage.setItem('my_gas_url', url);
            gasUrl = url;
            showToast('GAS 網址已儲存');
        }

        // --- Fetch Data from GAS (Transactions + Prices + Beta) ---
        async function fetchDataFromGAS(isSilent = false) {
            if (!gasUrl) {
                if(!isSilent) showAlert('提示', '請先輸入 Google Apps Script 網址');
                return;
            }

            const btnText = document.getElementById('btn-tx-fetch-text');
            const btnLoading = document.getElementById('btn-tx-fetch-loading');

            if(!isSilent && btnText) {
                btnText.textContent = '讀取中...';
                btnLoading.classList.remove('hidden');
            }

            try {
                const response = await fetch(gasUrl);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤 (${response.status})`);
                }
                const json = await response.json();
                
                // Handle potential GAS text output "Error: ..."
                if (json.error) {
                    throw new Error(json.error);
                }

                if (!isSilent) {
                    // Show debug info only for manual fetch
                    // Check structure
                    if (!json.transactions && !json.marketData) {
                         showAlert('資料格式錯誤', '回傳的 JSON 缺少 transactions 或 marketData 欄位。請檢查 GAS 腳本。', json);
                         return;
                    }
                }

                // Process Transactions
                if (json.transactions && Array.isArray(json.transactions)) {
                    processGASTransactions(json.transactions);
                }

                // Process Market Data (Price + Beta)
                if (json.marketData && Array.isArray(json.marketData)) {
                    processGASMarketData(json.marketData);
                }
                
                if (!isSilent) {
                    let msg = '資料同步成功！\n';
                    if(json.transactions) msg += `- 交易紀錄: ${json.transactions.length} 筆\n`;
                    if(json.marketData) msg += `- 市場數據: ${json.marketData.length} 筆`;
                    
                    showToast(msg);
                    closeDataSyncModal();
                }

            } catch (error) {
                console.error(error);
                if (!isSilent) {
                    showAlert('同步失敗', error.message + '\n請確認 GAS 網址與部署權限。');
                }
            } finally {
                if(!isSilent && btnText) {
                    btnText.textContent = '立即讀取資料';
                    btnLoading.classList.add('hidden');
                }
            }
        }

        function processGASTransactions(data) {
             const newTransactions = [];
             data.forEach((row, index) => {
                const id = Date.now() + index;
                if(!row.date || !row.symbol) return;

                // Handle Date (Fix UTC/Local Issue)
                let dateIso = row.date;
                if (typeof row.date === 'string' && row.date.indexOf('T') > -1) {
                    // Convert to Date object
                    const d = new Date(row.date);
                    // Format to local YYYY-MM-DD
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dateIso = `${year}-${month}-${day}`;
                }

                let action = 'BUY';
                const actStr = String(row.action).toUpperCase();
                if (actStr === '賣' || actStr === 'SELL' || actStr === 'S') {
                    action = 'SELL';
                }

                newTransactions.push({
                    id: id,
                    date: dateIso,
                    broker: row.broker,
                    symbol: String(row.symbol).toUpperCase(),
                    action: action,
                    qty: parseFloat(row.qty),
                    price: parseFloat(row.price),
                    currency: row.currency || 'TWD'
                });
             });

             transactions = newTransactions;
             saveData();
             renderTransactions();
        }

        function processGASMarketData(data) {
            // Expects array of objects: { symbol, price, beta }
            data.forEach(item => {
                const sym = String(item.symbol).toUpperCase();
                if (item.price) {
                    currentPrices[sym] = parseFloat(item.price);
                }
                if (item.beta !== undefined && item.beta !== "") {
                    symbolBetas[sym] = parseFloat(item.beta);
                }
            });
            
            localStorage.setItem('my_current_prices', JSON.stringify(currentPrices));
            localStorage.setItem('my_symbol_betas', JSON.stringify(symbolBetas));
            renderPortfolio();
        }

        // --- Transaction Functions (ADD & WRITE) ---
        async function addTransaction(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('btn-add-submit');
            const loadingIcon = document.getElementById('icon-upload-loading');
            
            const brokerSelect = document.getElementById('t-broker');
            const broker = brokerSelect.options[brokerSelect.selectedIndex].value;

            const newTx = {
                id: Date.now(),
                date: document.getElementById('t-date').value,
                action: document.getElementById('t-action').value,
                symbol: document.getElementById('t-symbol').value.toUpperCase().trim(),
                broker: broker,
                qty: parseFloat(document.getElementById('t-qty').value),
                price: parseFloat(document.getElementById('t-price').value),
                currency: document.getElementById('t-currency').value
            };

            // 1. Optimistic Update
            transactions.push(newTx);
            saveData();
            // We do NOT update current price locally on manual add anymore to prefer GAS source
            renderTransactions();
            
            // Reset Form inputs
            document.getElementById('t-symbol').value = '';
            document.getElementById('t-qty').value = '';
            document.getElementById('t-price').value = '';

            // 2. GAS Sync
            if (gasUrl) {
                submitBtn.disabled = true;
                loadingIcon.classList.remove('hidden');
                
                const sheetPayload = {
                    ...newTx,
                    action: newTx.action === 'BUY' ? '買' : '賣',
                    symbol: "'" + newTx.symbol
                };
                
                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(sheetPayload)
                    });
                    showToast('已新增並發送至 Google Sheet');
                } catch (error) {
                    console.error('GAS Sync Error:', error);
                    showAlert('寫入失敗', '寫入失敗，但已儲存至本地。');
                } finally {
                    submitBtn.disabled = false;
                    loadingIcon.classList.add('hidden');
                }
            } else {
                showToast('已新增至本地 (未設定 Google Sheet)');
            }
        }

        function deleteTransaction(id) {
            showConfirm('確定要刪除這筆紀錄嗎？\n(注意：這只會刪除本地紀錄，不會刪除 Google Sheet 上的資料)', () => {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
                renderPortfolio(); 
            });
        }

        function renderTransactions() {
            const list = document.getElementById('transaction-list');
            const countSpan = document.getElementById('tx-count');
            const emptyState = document.getElementById('empty-state-tx');

            list.innerHTML = '';
            
            const sortedTx = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedTx.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            countSpan.textContent = `${sortedTx.length} 筆`;

            sortedTx.forEach(tx => {
                const total = (tx.qty * tx.price).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
                const actionColor = tx.action === 'BUY' ? 'bg-red-600 text-white' : 'bg-green-600 text-white';
                const actionLabel = tx.action === 'BUY' ? '買入' : '賣出';

                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900 font-medium">${tx.date}</td>
                    <td class="px-6 py-4 font-bold text-blue-600">${tx.symbol} <span class="text-xs text-gray-400 font-normal block">${tx.broker || '-'}</span></td>
                    <td class="px-6 py-4"><span class="${actionColor} px-2 py-1 rounded text-xs font-bold">${actionLabel}</span></td>
                    <td class="px-6 py-4 text-right">${tx.qty.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right">${tx.price.toLocaleString()} <span class="text-xs text-gray-400">${tx.currency}</span></td>
                    <td class="px-6 py-4 text-right font-mono">${total}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteTransaction(${tx.id})" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        // --- Exchange Rate Logic ---
        function setRateMode(mode) {
            rateMode = mode;
            localStorage.setItem('my_rate_mode', mode);
            
            const btnManual = document.getElementById('mode-btn-manual');
            const btnAuto = document.getElementById('mode-btn-auto');
            const inputUsd = document.getElementById('rate-usd');
            const autoControls = document.getElementById('auto-rate-controls');

            if (mode === 'manual') {
                btnManual.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-blue-100 text-blue-700 shadow-sm";
                btnAuto.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-transparent text-gray-500 hover:bg-gray-100";
                inputUsd.removeAttribute('readonly');
                inputUsd.classList.remove('bg-gray-100', 'text-gray-500');
                inputUsd.classList.add('bg-white', 'text-gray-900');
                autoControls.classList.add('hidden');
            } else {
                btnManual.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-transparent text-gray-500 hover:bg-gray-100";
                btnAuto.className = "px-3 py-1 text-xs font-medium rounded-md transition-all bg-blue-100 text-blue-700 shadow-sm";
                inputUsd.setAttribute('readonly', true);
                inputUsd.classList.remove('bg-white', 'text-gray-900');
                inputUsd.classList.add('bg-gray-100', 'text-gray-500');
                autoControls.classList.remove('hidden');
                fetchRealTimeRate();
            }
        }

        async function fetchRealTimeRate() {
            if (rateMode !== 'auto') return;
            const icon = document.getElementById('icon-rate-refresh');
            const label = document.getElementById('rate-last-updated');
            icon.classList.add('fa-spin');
            label.textContent = '更新中...';

            const urls = [
                'https://open.er-api.com/v6/latest/USD',
                'https://api.exchangerate-api.com/v4/latest/USD'
            ];

            let success = false;

            for (const url of urls) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) continue; 
                    
                    const data = await res.json();
                    
                    if (data && data.rates && data.rates.TWD) {
                        let rate = data.rates.TWD;
                        // FIX: Round to 2 decimals for consistency with UI
                        rate = parseFloat(rate.toFixed(2));

                        exchangeRates['USD'] = rate;
                        localStorage.setItem('my_exchange_rates', JSON.stringify(exchangeRates));
                        document.getElementById('rate-usd').value = rate.toFixed(2);
                        
                        const now = new Date();
                        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                        label.textContent = `更新於 ${timeStr}`;
                        renderPortfolio();
                        showToast(`匯率已更新: 1 USD = ${rate.toFixed(2)} TWD`);
                        success = true;
                        break; 
                    }
                } catch (err) {
                    console.warn(`Failed to fetch from ${url}`, err);
                }
            }

            if (!success) {
                label.textContent = '更新失敗';
            }
            icon.classList.remove('fa-spin');
        }

        function updateExchangeRate(currency, value) {
            if (rateMode === 'auto' && currency === 'USD') return; 
            const rate = parseFloat(value);
            if(isNaN(rate) || rate <= 0) return;
            exchangeRates[currency] = rate;
            localStorage.setItem('my_exchange_rates', JSON.stringify(exchangeRates));
            renderPortfolio(); 
        }

        // New function to handle manual inputs save and recalc
        function saveManualAssetsAndRecalculate() {
            // Read values
            const cashTwd = parseFloat(document.getElementById('cash-twd').value.replace(/,/g, '')) || 0;
            const cashUsd = parseFloat(document.getElementById('cash-usd').value.replace(/,/g, '')) || 0;
            
            const mort = parseFloat(document.getElementById('liab-mortgage').value.replace(/,/g, '')) || 0;
            const loan = parseFloat(document.getElementById('liab-loan').value.replace(/,/g, '')) || 0;
            const pledge = parseFloat(document.getElementById('liab-pledge').value.replace(/,/g, '')) || 0;

            // Update State
            otherCash.TWD = cashTwd;
            otherCash.USD = cashUsd;
            liabilities.mortgage = mort;
            liabilities.loan = loan;
            liabilities.pledge = pledge;

            // Save to Storage
            localStorage.setItem('my_other_cash', JSON.stringify(otherCash));
            localStorage.setItem('my_liabilities', JSON.stringify(liabilities));

            // Re-render
            renderPortfolio();
            showToast('手動資產與負債數據已更新');
        }
        
        function toggleSoldOutRows() {
            isSoldOutExpanded = !isSoldOutExpanded;
            renderPortfolio();
        }

        // --- Portfolio Logic ---
        function calculatePortfolioData() {
            const portfolio = {};
            let totalPortfolioValueTWD = 0; 
            let totalInvestedCostTWD = 0;
            let totalGlobalRealizedPnLTWD = 0;

            const categoryTotals = {
                '原型': 0,
                '槓桿': 0,
                '類現金': 0,
                '其他': 0
            };

            const sortedTx = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedTx.forEach(tx => {
                if (!portfolio[tx.symbol]) {
                    // Assign beta here
                    const symbolBeta = getBeta(tx.symbol);
                    const category = getCategoryFromBeta(symbolBeta);

                    portfolio[tx.symbol] = {
                        symbol: tx.symbol,
                        currency: tx.currency,
                        beta: symbolBeta,
                        category: category,
                        inventory: 0,
                        totalCost: 0, 
                        totalBuyQty: 0,
                        totalBuyAmt: 0, 
                        soldQty: 0,
                        realizedPnL: 0,
                        avgCost: 0
                    };
                }
                
                const p = portfolio[tx.symbol];

                if (tx.action === 'BUY') {
                    p.inventory += tx.qty;
                    p.totalCost += (tx.qty * tx.price);
                    p.totalBuyQty += tx.qty;
                    p.totalBuyAmt += (tx.qty * tx.price);
                    if (p.inventory > 0) {
                        p.avgCost = p.totalCost / p.inventory;
                    }
                } else if (tx.action === 'SELL') {
                    const costBasis = p.avgCost * tx.qty;
                    const revenue = tx.price * tx.qty;
                    const profit = revenue - costBasis;

                    p.realizedPnL += profit;
                    p.inventory -= tx.qty;
                    p.totalCost -= costBasis;
                    p.soldQty += tx.qty;

                    if (p.inventory <= 0.000001) {
                        p.inventory = 0;
                        p.totalCost = 0;
                        p.avgCost = 0; 
                    }
                }
            });

            const result = Object.values(portfolio).map(p => {
                let currentPrice = currentPrices[p.symbol];
                if (currentPrice === undefined || currentPrice === null) {
                     const lastTx = transactions.filter(t => t.symbol === p.symbol).sort((a,b) => b.id - a.id)[0];
                     currentPrice = lastTx ? lastTx.price : 0;
                }

                const marketValue = p.inventory * currentPrice;
                const unrealizedPnL = marketValue - p.totalCost;
                const roi = p.totalCost > 0 ? (unrealizedPnL / p.totalCost) * 100 : 0;
                
                const rate = exchangeRates[p.currency] || 1;
                const marketValueTWD = marketValue * rate;
                
                // Calculate Unrealized PnL in TWD
                const unrealizedPnLTWD = unrealizedPnL * rate;
                
                // Tooltip Info (Original Currency)
                const tooltipInfo = `${formatMoney(unrealizedPnL)} ${p.currency} x ${rate} = ${formatMoney(unrealizedPnLTWD)}`;

                // Re-check beta in case manual update changed it
                p.beta = getBeta(p.symbol);
                p.category = getCategoryFromBeta(p.beta);

                if(p.inventory > 0) {
                    totalPortfolioValueTWD += marketValueTWD;
                    totalInvestedCostTWD += (p.totalCost * rate);
                    if(categoryTotals[p.category] !== undefined) {
                        categoryTotals[p.category] += marketValueTWD;
                    } else {
                        categoryTotals['其他'] += marketValueTWD;
                    }
                }
                
                totalGlobalRealizedPnLTWD += (p.realizedPnL * rate);

                return {
                    ...p,
                    currentPrice,
                    marketValue,
                    unrealizedPnL,
                    unrealizedPnLTWD, 
                    tooltipInfo,
                    roi,
                    marketValueTWD 
                };
            });

            // --- FIX START: Include Manual Cash in Beta & Category Calculations ---
            
            // 1. Calculate Manual Cash Value in TWD
            const rateUsd = exchangeRates['USD'] || 1;
            const manualCashTWD = (otherCash.TWD || 0) + ((otherCash.USD || 0) * rateUsd);

            // 2. Add to "類現金" Category Total (for Pie Chart)
            categoryTotals['類現金'] += manualCashTWD;

            // 3. Calculate Total Assets (Stocks + Cash) for Beta Weighting
            const totalAssetsValue = totalPortfolioValueTWD + manualCashTWD;

            // 4. Calculate Allocation % based on Stocks Only (for table display - optional, usually % of portfolio)
            // But for Beta, we need % of Total Assets
            
            // Let's update allocation in table to be % of Stock Portfolio (or Total? usually Total is better)
            // Sticking to % of Stock Portfolio for the table column "占比" to sum to 100% of stocks is common,
            // BUT for Beta, we MUST use totalAssets.
            
            result.forEach(p => {
                // Table allocation: stick to % of Stock Portfolio for now to avoid confusion or change to Total?
                // Let's keep table allocation as % of Stock Portfolio for consistency with "Stock Holdings" table.
                p.allocation = totalPortfolioValueTWD > 0 ? (p.marketValueTWD / totalPortfolioValueTWD) * 100 : 0;
            });

            result.sort((a, b) => b.allocation - a.allocation);

            // 5. Calculate Weighted Beta
            // Beta = Sum ( (AssetValue / TotalAssets) * AssetBeta )
            // Cash Beta is 0, so we just add 0. The dilution happens because denominator increases.
            let totalBeta = 0;
            result.forEach(p => {
                if (p.inventory > 0) {
                    const weight = totalAssetsValue > 0 ? (p.marketValueTWD / totalAssetsValue) : 0;
                    totalBeta += (weight * p.beta);
                }
            });

            // 6. Recalculate Category Percentages for Stats Display (using Total Assets)
            const catPcts = {
                '原型': totalAssetsValue > 0 ? categoryTotals['原型'] / totalAssetsValue : 0,
                '槓桿': totalAssetsValue > 0 ? categoryTotals['槓桿'] / totalAssetsValue : 0,
                '類現金': totalAssetsValue > 0 ? categoryTotals['類現金'] / totalAssetsValue : 0,
                '其他': totalAssetsValue > 0 ? categoryTotals['其他'] / totalAssetsValue : 0,
            };
            // --- FIX END ---

            return { 
                items: result, 
                totalValue: totalPortfolioValueTWD, // Stock Value Only (for dashboard separation)
                totalCost: totalInvestedCostTWD,
                totalRealized: totalGlobalRealizedPnLTWD,
                categoryTotals: categoryTotals,     // Includes Cash
                catPcts: catPcts,                   // Includes Cash
                beta: totalBeta                     // Diluted by Cash
            };
        }

        function renderPortfolio() {
            const data = calculatePortfolioData();
            const list = document.getElementById('portfolio-list');
            const emptyState = document.getElementById('empty-state-pf');

            // --- Update Dashboard with Cash & Liabilities ---
            const rateUsd = exchangeRates['USD'] || 1;
            const totalCashTWD = (otherCash.TWD || 0) + ((otherCash.USD || 0) * rateUsd);
            const totalLiabilitiesTWD = (liabilities.mortgage || 0) + (liabilities.loan || 0) + (liabilities.pledge || 0);
            
            // --- Dashboard Updates ---
            
            // 1. Assets Distribution
            safeSetText('dash-stock-value', formatMoney(data.totalValue));
            safeSetText('dash-stock-cost', formatMoney(data.totalCost));
            safeSetText('dash-cash-value', formatMoney(totalCashTWD));

            // 3. Balance Sheet
            const totalAssets = data.totalValue + totalCashTWD;
            safeSetText('dash-total-assets', formatMoney(totalAssets));
            safeSetText('dash-liabilities', formatMoney(totalLiabilitiesTWD));

            // 4. Net Worth
            const netWorth = totalAssets - totalLiabilitiesTWD;
            safeSetText('dash-net-worth', formatMoney(netWorth));

            // 2. Performance (PnL)
            const totalUnrealizedTWD = data.totalValue - data.totalCost; 
            const totalRealizedTWD = data.totalRealized;
            const totalCombinedPnL = totalUnrealizedTWD + totalRealizedTWD;

            updatePnlElement('total-unrealized-pnl', totalUnrealizedTWD);
            updatePnlElement('total-realized-pnl', totalRealizedTWD);
            updatePnlElement('total-combined-pnl', totalCombinedPnL, {maximumFractionDigits: 0});

            // Analysis Stats
            document.getElementById('stat-proto-val').textContent = (data.catPcts['原型'] * 100).toFixed(1) + '%';
            document.getElementById('stat-proto-amt').textContent = formatMoney(data.categoryTotals['原型']);
            
            document.getElementById('stat-lev-val').textContent = (data.catPcts['槓桿'] * 100).toFixed(1) + '%';
            document.getElementById('stat-lev-amt').textContent = formatMoney(data.categoryTotals['槓桿']);
            
            document.getElementById('stat-cash-val').textContent = (data.catPcts['類現金'] * 100).toFixed(1) + '%';
            document.getElementById('stat-cash-amt').textContent = formatMoney(data.categoryTotals['類現金']);

            document.getElementById('stat-beta').textContent = data.beta.toFixed(2);

            updateAllocationChart(data.categoryTotals);
            
            list.innerHTML = '';

            if (data.items.length === 0) {
                // emptyState.classList.remove('hidden'); // Removed due to potential issues
                return;
            }
            // emptyState.classList.add('hidden'); // Removed due to potential issues

            // Split items into active and sold out
            const activeItems = data.items.filter(p => p.inventory > 0.000001);
            const soldItems = data.items.filter(p => p.inventory <= 0.000001);

            // Render Active Items
            activeItems.forEach(p => {
                const isHold = true; // Fix: Explicitly set isHold for active items
                const roiClass = getColorClass(p.roi);
                const pnlClass = getColorClass(p.unrealizedPnLTWD); // Use TWD Value for color
                const realizedClass = getColorClass(p.realizedPnL);
                const catColor = CATEGORY_COLORS[p.category] || '#9ca3af';

                // Add Tooltips for transparency
                const avgCostTooltip = `總成本: ${formatMoney(p.totalCost)}`;

                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50 transition-colors';
                
                // Removed the Beta Input Column from Table
                row.innerHTML = `
                    <td class="px-4 py-4">
                        <span class="px-2 py-1 rounded text-xs text-white font-bold whitespace-nowrap" style="background-color: ${catColor}">
                            ${p.category}
                        </span>
                    </td>
                    <td class="px-4 py-4 font-bold text-gray-800">
                        ${p.symbol} 
                        <span class="text-xs text-gray-400 font-normal ml-1">${p.currency}</span>
                    </td>
                    <td class="px-4 py-4 text-right ${isHold ? 'font-bold' : 'text-gray-300'}">
                        ${formatNumber(p.inventory)}
                    </td>
                    <td class="px-4 py-4 text-right bg-yellow-50 border-l border-yellow-100 relative group">
                        <span class="font-mono text-gray-700">${formatMoney(p.currentPrice, {maximumFractionDigits: 2})}</span>
                    </td>
                    <td class="px-4 py-4 text-right font-mono font-medium text-gray-700">
                        ${isHold ? formatMoney(p.marketValue) : '-'}
                    </td>
                    <td class="px-4 py-4 text-right text-gray-500 text-xs" title="${avgCostTooltip}">
                        ${isHold ? formatMoney(p.avgCost) : '-'}
                    </td>
                    <td class="px-4 py-4 text-right font-medium ${pnlClass}" title="${p.tooltipInfo}">
                        ${isHold ? formatMoney(p.unrealizedPnLTWD, {maximumFractionDigits: 0}) : '-'}
                    </td>
                    <td class="px-4 py-4 text-right font-bold ${roiClass}">
                        ${isHold ? p.roi.toFixed(2) + '%' : '-'}
                    </td>
                    <td class="px-4 py-4 text-right text-xs text-gray-500">
                        ${isHold ? p.allocation.toFixed(1) + '%' : '0.0%'}
                    </td>
                `;
                list.appendChild(row);
            });

            // Render Sold Out Toggle & Items
            if (soldItems.length > 0) {
                // Separator Row
                const separatorRow = document.createElement('tr');
                separatorRow.className = 'bg-gray-100 cursor-pointer hover:bg-gray-200 transition-colors';
                separatorRow.onclick = toggleSoldOutRows;
                separatorRow.innerHTML = `
                    <td colspan="9" class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                        <i class="fa-solid fa-chevron-${isSoldOutExpanded ? 'up' : 'down'} mr-2"></i>
                        已清倉項目 (${soldItems.length} 筆)
                    </td>
                `;
                list.appendChild(separatorRow);

                if (isSoldOutExpanded) {
                    soldItems.forEach(p => {
                        // For sold items, most values are 0 or not applicable, show realized PnL mainly
                        const realizedClass = getColorClass(p.realizedPnL);
                        const catColor = CATEGORY_COLORS[p.category] || '#9ca3af';

                        const row = document.createElement('tr');
                        row.className = 'bg-gray-50 border-b text-gray-400';
                        
                        row.innerHTML = `
                            <td class="px-4 py-4 opacity-50">
                                <span class="px-2 py-1 rounded text-xs text-white font-bold whitespace-nowrap opacity-50" style="background-color: ${catColor}">
                                    ${p.category}
                                </span>
                            </td>
                            <td class="px-4 py-4 font-medium opacity-75">
                                ${p.symbol} 
                                <span class="text-xs font-normal ml-1">${p.currency}</span>
                            </td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                            <td class="px-4 py-4 text-right text-xs">-</td>
                        `;
                        list.appendChild(row);
                    });
                }
            }
        }

        // Restored updateAllocationChart function
        function updateAllocationChart(totals) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            const labels = ['原型', '槓桿', '類現金', '其他'];
            const dataValues = labels.map(l => totals[l]);
            const colors = labels.map(l => CATEGORY_COLORS[l]);

            if (chartInstance) {
                chartInstance.destroy();
            }

            // Check if there is data to display
            if (Object.values(totals).reduce((a, b) => a + b, 0) === 0) return;

            // Custom Plugin to draw lines and labels outside the pie chart
            const pieLabelsLinePlugin = {
                id: 'pieLabelsLine',
                afterDraw(chart) {
                    const { ctx, chartArea: { width, height } } = chart;
                    
                    chart.data.datasets.forEach((dataset, i) => {
                        chart.getDatasetMeta(i).data.forEach((datapoint, index) => {
                            const value = dataset.data[index];
                            if (value <= 0) return;

                            const { x, y } = datapoint.tooltipPosition();
                            
                            // Center of the chart
                            const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                            const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                            
                            // Calculate angle
                            const angle = Math.atan2(y - centerY, x - centerX);
                            
                            // Radius for the line start and end
                            const outerRadius = datapoint.outerRadius;
                            const lineStartRadius = outerRadius;
                            const lineEndRadius = outerRadius + 20; // Length of the line outward
                            
                            // Calculate points
                            const xStart = centerX + Math.cos(angle) * lineStartRadius;
                            const yStart = centerY + Math.sin(angle) * lineStartRadius;
                            const xEnd = centerX + Math.cos(angle) * lineEndRadius;
                            const yEnd = centerY + Math.sin(angle) * lineEndRadius;
                            
                            // Draw Line
                            ctx.beginPath();
                            ctx.moveTo(xStart, yStart);
                            ctx.lineTo(xEnd, yEnd);
                            // Draw horizontal line based on side
                            const isRight = xEnd > centerX;
                            const xText = isRight ? xEnd + 10 : xEnd - 10;
                            ctx.lineTo(xText, yEnd);
                            ctx.strokeStyle = '#666';
                            ctx.stroke();
                            
                            // Draw Text
                            const total = dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                            const labelText = `${chart.data.labels[index]} ${percentage}`;
                            
                            ctx.font = '11px Arial';
                            ctx.fillStyle = '#333';
                            ctx.textAlign = isRight ? 'left' : 'right';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(labelText, isRight ? xText + 5 : xText - 5, yEnd);
                        });
                    });
                }
            };

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 40 // Add padding for external labels
                    },
                    plugins: {
                        legend: {
                            display: false 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.raw;
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const pct = ((val / total) * 100).toFixed(1) + '%';
                                    return `${context.label}: ${formatMoney(val)} (${pct})`;
                                }
                            }
                        }
                    }
                },
                plugins: [pieLabelsLinePlugin] // Register the custom plugin here
            });
        }

        function updatePrice(symbol, newPrice) {
            currentPrices[symbol] = parseFloat(newPrice);
            localStorage.setItem('my_current_prices', JSON.stringify(currentPrices));
            renderPortfolio(); 
        }

        // --- Utilities ---
        function saveData() {
            localStorage.setItem('my_transactions', JSON.stringify(transactions));
        }

        function confirmClearAllData() {
            showConfirm('警告：這將刪除所有交易紀錄與價格設定，且無法復原。確定嗎？', () => {
                localStorage.removeItem('my_transactions');
                localStorage.removeItem('my_current_prices');
                localStorage.removeItem('my_sheet_url');
                localStorage.removeItem('my_tx_sheet_url');
                localStorage.removeItem('my_gas_url'); 
                localStorage.removeItem('my_exchange_rates');
                localStorage.removeItem('my_other_cash'); 
                localStorage.removeItem('my_liabilities'); 
                localStorage.removeItem('my_symbol_betas'); // Clear betas
                transactions = [];
                currentPrices = {};
                symbolBetas = {};
                renderTransactions();
                renderPortfolio();
                showToast('所有資料已清除');
            });
        }

        function formatMoney(num, options) {
            if (num === undefined || num === null) return '0';
            const defaultOptions = {minimumFractionDigits: 0, maximumFractionDigits: 2};
            const finalOptions = { ...defaultOptions, ...options }; // Merge user options
            return num.toLocaleString(undefined, finalOptions);
        }

        function formatNumber(num) {
             return num.toLocaleString(undefined, {maximumFractionDigits: 4});
        }

        function getColorClass(val) {
            if (val > 0) return 'text-red-500'; 
            if (val < 0) return 'text-green-500'; 
            return 'text-gray-400';
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = 'fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm animate-bounce z-50';
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

    </script>
</body>
</html>